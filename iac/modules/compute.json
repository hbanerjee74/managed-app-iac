{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "14870609158994185526"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Deployment location."
      }
    },
    "sku": {
      "type": "string",
      "metadata": {
        "description": "App Service Plan SKU (RFC-64 sku)."
      }
    },
    "aspName": {
      "type": "string",
      "metadata": {
        "description": "App Service Plan name."
      }
    },
    "appApiName": {
      "type": "string",
      "metadata": {
        "description": "API App name."
      }
    },
    "appUiName": {
      "type": "string",
      "metadata": {
        "description": "UI App name."
      }
    },
    "funcName": {
      "type": "string",
      "metadata": {
        "description": "Function App name."
      }
    },
    "subnetAppsvcId": {
      "type": "string",
      "metadata": {
        "description": "App Service VNet integration subnet id."
      }
    },
    "subnetPeId": {
      "type": "string",
      "metadata": {
        "description": "Private Endpoints subnet ID."
      }
    },
    "uamiId": {
      "type": "string",
      "metadata": {
        "description": "User-assigned managed identity resource id."
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage account name for Function runtime state (identity-based)."
      }
    },
    "lawId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace resource ID."
      }
    },
    "zoneIds": {
      "type": "object",
      "metadata": {
        "description": "DNS zone resource IDs map (from dns module)."
      }
    },
    "peAppApiName": {
      "type": "string",
      "metadata": {
        "description": "Private endpoint names from naming helper."
      }
    },
    "peAppUiName": {
      "type": "string"
    },
    "peFuncName": {
      "type": "string"
    },
    "peAppApiDnsName": {
      "type": "string",
      "metadata": {
        "description": "Private DNS zone group names from naming helper."
      }
    },
    "peAppUiDnsName": {
      "type": "string"
    },
    "peFuncDnsName": {
      "type": "string"
    },
    "diagAppApiName": {
      "type": "string",
      "metadata": {
        "description": "Diagnostic setting names from naming helper."
      }
    },
    "diagAppUiName": {
      "type": "string"
    },
    "diagFuncName": {
      "type": "string"
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tags to apply."
      }
    }
  },
  "variables": {
    "storageSuffix": "[environment().suffixes.storage]",
    "storageBlobUri": "[format('https://{0}.blob.{1}', parameters('storageAccountName'), variables('storageSuffix'))]",
    "storageQueueUri": "[format('https://{0}.queue.{1}', parameters('storageAccountName'), variables('storageSuffix'))]",
    "defaultContainer": "mcr.microsoft.com/azuredocs/aci-helloworld:latest"
  },
  "resources": [
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[parameters('aspName')]",
      "location": "[parameters('location')]",
      "kind": "linux",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "[parameters('sku')]",
        "tier": "PremiumV3"
      },
      "properties": {
        "reserved": true,
        "zoneRedundant": false
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('appApiName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux,container",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('uamiId'))]": {}
        }
      },
      "properties": {
        "httpsOnly": true,
        "publicNetworkAccess": "Disabled",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
        "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
        "siteConfig": {
          "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
          "ftpsState": "Disabled",
          "minTlsVersion": "1.2",
          "alwaysOn": true,
          "vnetRouteAllEnabled": true,
          "scmIpSecurityRestrictionsDefaultAction": "Deny",
          "ipSecurityRestrictionsDefaultAction": "Deny"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('appUiName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux,container",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('uamiId'))]": {}
        }
      },
      "properties": {
        "httpsOnly": true,
        "publicNetworkAccess": "Disabled",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
        "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
        "siteConfig": {
          "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
          "ftpsState": "Disabled",
          "minTlsVersion": "1.2",
          "alwaysOn": true,
          "vnetRouteAllEnabled": true,
          "scmIpSecurityRestrictionsDefaultAction": "Deny",
          "ipSecurityRestrictionsDefaultAction": "Deny"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[parameters('funcName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp,linux,container",
      "tags": "[parameters('tags')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('uamiId'))]": {}
        }
      },
      "properties": {
        "httpsOnly": true,
        "publicNetworkAccess": "Disabled",
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
        "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
        "siteConfig": {
          "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
          "ftpsState": "Disabled",
          "minTlsVersion": "1.2",
          "alwaysOn": true,
          "vnetRouteAllEnabled": true,
          "scmIpSecurityRestrictionsDefaultAction": "Deny",
          "ipSecurityRestrictionsDefaultAction": "Deny",
          "appSettings": [
            {
              "name": "AzureWebJobsStorage__accountName",
              "value": "[parameters('storageAccountName')]"
            },
            {
              "name": "AzureWebJobsStorage__blobServiceUri",
              "value": "[variables('storageBlobUri')]"
            },
            {
              "name": "AzureWebJobsStorage__queueServiceUri",
              "value": "[variables('storageQueueUri')]"
            },
            {
              "name": "AzureWebJobsStorage__credential",
              "value": "ManagedIdentity"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "custom"
            },
            {
              "name": "WEBSITE_CONTENTOVERVNET",
              "value": "1"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peAppApiName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "appapi-conn",
            "properties": {
              "groupIds": [
                "sites"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peAppApiName'), parameters('peAppApiDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink.azurewebsites.net",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAppApiName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peAppUiName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "appui-conn",
            "properties": {
              "groupIds": [
                "sites"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peAppUiName'), parameters('peAppUiDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink.azurewebsites.net",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAppUiName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peFuncName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "func-conn",
            "properties": {
              "groupIds": [
                "sites"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peFuncName'), parameters('peFuncDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink.azurewebsites.net",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peFuncName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Web/sites/{0}', parameters('appApiName'))]",
      "name": "[parameters('diagAppApiName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "AppServiceHTTPLogs",
            "enabled": true
          },
          {
            "category": "AppServiceConsoleLogs",
            "enabled": true
          },
          {
            "category": "AppServiceAppLogs",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Web/sites/{0}', parameters('appUiName'))]",
      "name": "[parameters('diagAppUiName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "AppServiceHTTPLogs",
            "enabled": true
          },
          {
            "category": "AppServiceConsoleLogs",
            "enabled": true
          },
          {
            "category": "AppServiceAppLogs",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Web/sites/{0}', parameters('funcName'))]",
      "name": "[parameters('diagFuncName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "FunctionAppLogs",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
      ]
    }
  ],
  "outputs": {
    "appApiId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
    },
    "appUiId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
    },
    "funcId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
    }
  }
}