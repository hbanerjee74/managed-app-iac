{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "1986632093217677148"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "Deployment location."
      }
    },
    "kvName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault name."
      }
    },
    "storageName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account name."
      }
    },
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name."
      }
    },
    "subnetPeId": {
      "type": "string",
      "metadata": {
        "description": "Private Endpoints subnet ID."
      }
    },
    "uamiPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "Principal ID of the UAMI for RBAC."
      }
    },
    "lawId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace resource ID."
      }
    },
    "zoneIds": {
      "type": "object",
      "metadata": {
        "description": "DNS zone resource IDs map (from dns module)."
      }
    },
    "peKvName": {
      "type": "string",
      "metadata": {
        "description": "Private endpoint names from naming helper."
      }
    },
    "peStBlobName": {
      "type": "string"
    },
    "peStQueueName": {
      "type": "string"
    },
    "peStTableName": {
      "type": "string"
    },
    "peAcrName": {
      "type": "string"
    },
    "peKvDnsName": {
      "type": "string",
      "metadata": {
        "description": "Private DNS zone group names from naming helper."
      }
    },
    "peStBlobDnsName": {
      "type": "string"
    },
    "peStQueueDnsName": {
      "type": "string"
    },
    "peStTableDnsName": {
      "type": "string"
    },
    "peAcrDnsName": {
      "type": "string"
    },
    "diagKvName": {
      "type": "string",
      "metadata": {
        "description": "Diagnostic setting names from naming helper."
      }
    },
    "diagStName": {
      "type": "string"
    },
    "diagAcrName": {
      "type": "string"
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Optional tags to apply."
      }
    }
  },
  "variables": {
    "storageSuffix": "[environment().suffixes.storage]",
    "blobZone": "[format('privatelink.blob.{0}', variables('storageSuffix'))]",
    "queueZone": "[format('privatelink.queue.{0}', variables('storageSuffix'))]",
    "tableZone": "[format('privatelink.table.{0}', variables('storageSuffix'))]"
  },
  "resources": [
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-02-01",
      "name": "[parameters('kvName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "enablePurgeProtection": true,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "publicNetworkAccess": "Disabled",
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "networkAcls": {
          "defaultAction": "Deny",
          "bypass": "AzureServices"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "minimumTlsVersion": "TLS1_2",
        "supportsHttpsTrafficOnly": true,
        "allowBlobPublicAccess": false,
        "allowSharedKeyAccess": false,
        "publicNetworkAccess": "Disabled",
        "defaultToOAuthAuthentication": true
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/default/artifacts', parameters('storageName'))]",
      "properties": {
        "publicAccess": "None",
        "defaultEncryptionScope": "$account-encryption-key",
        "denyEncryptionScopeOverride": false,
        "metadata": {
          "tier": "Cool"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "copy": {
        "name": "queues",
        "count": "[length(createArray('health-notifications-queue', 'update-notifications-queue', 'monitor-alerts-queue'))]"
      },
      "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/default/{1}', parameters('storageName'), createArray('health-notifications-queue', 'update-notifications-queue', 'monitor-alerts-queue')[copyIndex()])]",
      "properties": {
        "metadata": {}
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "copy": {
        "name": "tables",
        "count": "[length(createArray('engineHistory', 'engineDlq'))]"
      },
      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
      "apiVersion": "2023-01-01",
      "name": "[format('{0}/default/{1}', parameters('storageName'), createArray('engineHistory', 'engineDlq')[copyIndex()])]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-06-01-preview",
      "name": "[parameters('acrName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "sku": {
        "name": "Premium"
      },
      "properties": {
        "adminUserEnabled": false,
        "publicNetworkAccess": "Disabled",
        "zoneRedundancy": "Disabled",
        "dataEndpointEnabled": false
      }
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peKvName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "kv-conn",
            "properties": {
              "groupIds": [
                "vault"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peKvName'), parameters('peKvDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink.vaultcore.azure.net",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').vault]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peKvName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peStBlobName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "st-blob-conn",
            "properties": {
              "groupIds": [
                "blob"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peStBlobName'), parameters('peStBlobDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "[variables('blobZone')]",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').blob]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStBlobName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peStQueueName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "st-queue-conn",
            "properties": {
              "groupIds": [
                "queue"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peStQueueName'), parameters('peStQueueDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "[variables('queueZone')]",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').queue]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStQueueName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peStTableName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "st-table-conn",
            "properties": {
              "groupIds": [
                "table"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peStTableName'), parameters('peStTableDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "[variables('tableZone')]",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').table]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStTableName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints",
      "apiVersion": "2023-05-01",
      "name": "[parameters('peAcrName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]",
      "properties": {
        "subnet": {
          "id": "[parameters('subnetPeId')]"
        },
        "privateLinkServiceConnections": [
          {
            "name": "acr-conn",
            "properties": {
              "groupIds": [
                "registry"
              ],
              "privateLinkServiceId": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
      "apiVersion": "2023-05-01",
      "name": "[format('{0}/{1}', parameters('peAcrName'), parameters('peAcrDnsName'))]",
      "properties": {
        "privateDnsZoneConfigs": [
          {
            "name": "privatelink.azurecr.io",
            "properties": {
              "privateDnsZoneId": "[parameters('zoneIds').acr]"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAcrName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('kvName'))]",
      "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('kvName')), parameters('uamiPrincipalId'), 'kv-secret-officer')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
        "principalId": "[parameters('uamiPrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('uamiPrincipalId'), 'st-blob-data-contrib')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
        "principalId": "[parameters('uamiPrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
      "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('uamiPrincipalId'), 'st-queue-data-contrib')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '19e7f393-1728-4e7a-9c12-054fda5c492f')]",
        "principalId": "[parameters('uamiPrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('uamiPrincipalId'), 'acr-pull')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
        "principalId": "[parameters('uamiPrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2020-04-01-preview",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('uamiPrincipalId'), 'acr-push')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8311e382-0749-4cb8-b61a-304f252e45ec')]",
        "principalId": "[parameters('uamiPrincipalId')]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('kvName'))]",
      "name": "[parameters('diagKvName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "AuditEvent",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
      "name": "[parameters('diagStName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "StorageRead",
            "enabled": true
          },
          {
            "category": "StorageWrite",
            "enabled": true
          },
          {
            "category": "StorageDelete",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[parameters('diagAcrName')]",
      "properties": {
        "workspaceId": "[parameters('lawId')]",
        "logs": [
          {
            "category": "ContainerRegistryRepositoryEvents",
            "enabled": true
          },
          {
            "category": "ContainerRegistryLoginEvents",
            "enabled": true
          }
        ],
        "metrics": [
          {
            "category": "AllMetrics",
            "enabled": true
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
      ]
    }
  ],
  "outputs": {
    "kvId": {
      "type": "string",
      "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
    },
    "storageId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
    },
    "acrId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
    }
  }
}