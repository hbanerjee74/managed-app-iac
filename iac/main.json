{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4438027171907693447"
    }
  },
  "parameters": {
    "resourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Existing resource group where all resources will be deployed (RFC-64: resourceGroup)."
      }
    },
    "mrgName": {
      "type": "string",
      "metadata": {
        "description": "Managed Resource Group name (RFC-64 mrgName)."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region for deployment."
      }
    },
    "adminObjectId": {
      "type": "string",
      "metadata": {
        "description": "Customer admin Entra object ID (RFC-64)."
      }
    },
    "contactEmail": {
      "type": "string",
      "metadata": {
        "description": "Contact email for notifications (RFC-64)."
      }
    },
    "adminPrincipalType": {
      "type": "string",
      "defaultValue": "User",
      "allowedValues": [
        "User",
        "Group"
      ],
      "metadata": {
        "description": "Principal type for adminObjectId (User or Group)."
      }
    },
    "servicesVnetCidr": {
      "type": "string",
      "defaultValue": "10.100.0.0/24",
      "metadata": {
        "description": "Services VNet CIDR block (RFC-64)."
      }
    },
    "customerIpRanges": {
      "type": "array",
      "minLength": 1,
      "metadata": {
        "description": "Customer IP ranges for WAF allowlist (RFC-64)."
      }
    },
    "publisherIpRanges": {
      "type": "array",
      "minLength": 1,
      "metadata": {
        "description": "Publisher IP ranges for WAF allowlist (RFC-64)."
      }
    },
    "sku": {
      "type": "string",
      "defaultValue": "P1v3",
      "allowedValues": [
        "P1v3",
        "P2v3",
        "P3v3"
      ],
      "metadata": {
        "description": "App Service Plan SKU (RFC-64 sku)."
      }
    },
    "nodeSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v3",
      "allowedValues": [
        "Standard_D4s_v3",
        "Standard_D8s_v3",
        "Standard_D16s_v3"
      ],
      "metadata": {
        "description": "AKS node size (RFC-64 nodeSize). Note: Parameter defined per RFC-64 but currently unused as AKS deployment is out of scope for PRD-30."
      }
    },
    "computeTier": {
      "type": "string",
      "defaultValue": "GP_Standard_D2s_v3",
      "allowedValues": [
        "GP_Standard_D2s_v3",
        "GP_Standard_D4s_v3"
      ],
      "metadata": {
        "description": "PostgreSQL compute tier (RFC-64 computeTier)."
      }
    },
    "aiServicesTier": {
      "type": "string",
      "defaultValue": "S1",
      "allowedValues": [
        "S1",
        "S2",
        "S3"
      ],
      "metadata": {
        "description": "AI Services tier (RFC-64)."
      }
    },
    "retentionDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 30,
      "maxValue": 730,
      "metadata": {
        "description": "Log Analytics retention in days (RFC-64 retentionDays display)."
      }
    },
    "appGwCapacity": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 1,
      "maxValue": 10,
      "metadata": {
        "description": "Application Gateway capacity (RFC-64 appGwCapacity display)."
      }
    },
    "appGwSku": {
      "type": "string",
      "defaultValue": "WAF_v2",
      "allowedValues": [
        "WAF_v2"
      ],
      "metadata": {
        "description": "Application Gateway SKU (RFC-64 appGwSku display)."
      }
    },
    "storageGB": {
      "type": "int",
      "defaultValue": 128,
      "minValue": 32,
      "maxValue": 16384,
      "metadata": {
        "description": "PostgreSQL storage in GB (RFC-64 storageGB display)."
      }
    },
    "backupRetentionDays": {
      "type": "int",
      "defaultValue": 7,
      "minValue": 7,
      "maxValue": 35,
      "metadata": {
        "description": "PostgreSQL backup retention days (RFC-64 backupRetentionDays display)."
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional tags: environment (dev/release/prod), owner, purpose, created (ISO8601)."
      }
    },
    "owner": {
      "type": "string",
      "defaultValue": ""
    },
    "purpose": {
      "type": "string",
      "defaultValue": ""
    },
    "created": {
      "type": "string",
      "defaultValue": ""
    }
  },
  "variables": {
    "tags": "[union(if(empty(parameters('environment')), createObject(), createObject('environment', parameters('environment'))), if(empty(parameters('owner')), createObject(), createObject('owner', parameters('owner'))), if(empty(parameters('purpose')), createObject(), createObject('purpose', parameters('purpose'))), if(empty(parameters('created')), createObject(), createObject('created', parameters('created'))), if(empty(parameters('contactEmail')), createObject(), createObject('contactEmail', parameters('contactEmail'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "naming",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceGroupName": {
            "value": "[parameters('mrgName')]"
          },
          "purpose": {
            "value": "platform"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6611002162306895913"
            }
          },
          "functions": [
            {
              "namespace": "__bicep",
              "members": {
                "nano16": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "seed"
                    },
                    {
                      "type": "string",
                      "name": "suffix"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[toLower(format('{0}{1}', substring(uniqueString(format('{0}-{1}-a', parameters('seed'), parameters('suffix'))), 0, 8), substring(uniqueString(format('{0}-{1}-b', parameters('seed'), parameters('suffix'))), 0, 8)))]"
                  }
                },
                "nano8": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "seed"
                    },
                    {
                      "type": "string",
                      "name": "suffix"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[toLower(substring(uniqueString(format('{0}-{1}-st', parameters('seed'), parameters('suffix'))), 0, 8))]"
                  }
                }
              }
            }
          ],
          "parameters": {
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group name used as seed for deterministic nanoid generation."
              }
            },
            "purpose": {
              "type": "string",
              "defaultValue": "platform",
              "metadata": {
                "description": "Logical purpose string to include in names (e.g., platform)."
              }
            },
            "seedPrefix": {
              "type": "string",
              "defaultValue": "[parameters('resourceGroupName')]"
            }
          },
          "variables": {
            "names": {
              "uami": "[format('vd-uami-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'uami'))]",
              "vnet": "[format('vd-vnet-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'vnet'))]",
              "nsgAppgw": "[format('vd-nsg-appgw-{0}', __bicep.nano16(parameters('seedPrefix'), 'nsgappgw'))]",
              "nsgAks": "[format('vd-nsg-aks-{0}', __bicep.nano16(parameters('seedPrefix'), 'nsgaks'))]",
              "nsgAppsvc": "[format('vd-nsg-appsvc-{0}', __bicep.nano16(parameters('seedPrefix'), 'nsgappsvc'))]",
              "nsgPe": "[format('vd-nsg-pe-{0}', __bicep.nano16(parameters('seedPrefix'), 'nsgpe'))]",
              "kv": "[format('vd-kv-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'kv'))]",
              "storage": "[format('vdst{0}{1}', parameters('purpose'), __bicep.nano8(parameters('seedPrefix'), 'st'))]",
              "acr": "[format('vd-acr-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'acr'))]",
              "law": "[format('vd-law-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'law'))]",
              "asp": "[format('vd-asp-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'asp'))]",
              "appApi": "[format('vd-app-api-{0}', __bicep.nano16(parameters('seedPrefix'), 'appapi'))]",
              "appUi": "[format('vd-app-ui-{0}', __bicep.nano16(parameters('seedPrefix'), 'appui'))]",
              "funcOps": "[format('vd-func-ops-{0}', __bicep.nano16(parameters('seedPrefix'), 'func'))]",
              "agw": "[format('vd-agw-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'agw'))]",
              "pipAgw": "[format('vd-pip-agw-{0}', __bicep.nano16(parameters('seedPrefix'), 'pipagw'))]",
              "psql": "[format('vd-psql-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'psql'))]",
              "search": "[format('vd-search-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'search'))]",
              "ai": "[format('vd-ai-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'ai'))]",
              "automation": "[format('vd-aa-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'aa'))]",
              "logic": "[format('vd-logic-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'logic'))]",
              "peKv": "[format('vd-pe-kv-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pekv'))]",
              "peStBlob": "[format('vd-pe-st-blob-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pestblob'))]",
              "peStQueue": "[format('vd-pe-st-queue-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pestqueue'))]",
              "peStTable": "[format('vd-pe-st-table-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pesttable'))]",
              "peAcr": "[format('vd-pe-acr-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'peacr'))]",
              "peAppApi": "[format('vd-pe-app-api-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'peappapi'))]",
              "peAppUi": "[format('vd-pe-app-ui-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'peappui'))]",
              "peFunc": "[format('vd-pe-func-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pefunc'))]",
              "peSearch": "[format('vd-pe-search-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pesearch'))]",
              "peAi": "[format('vd-pe-ai-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'peai'))]",
              "peAutomation": "[format('vd-pe-aa-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'peaa'))]",
              "peKvDns": "[format('vd-pdns-kv-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnskv'))]",
              "peStBlobDns": "[format('vd-pdns-st-blob-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsstblob'))]",
              "peStQueueDns": "[format('vd-pdns-st-queue-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsstqueue'))]",
              "peStTableDns": "[format('vd-pdns-st-table-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnssttable'))]",
              "peAcrDns": "[format('vd-pdns-acr-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsacr'))]",
              "peAppApiDns": "[format('vd-pdns-app-api-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsappapi'))]",
              "peAppUiDns": "[format('vd-pdns-app-ui-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsappui'))]",
              "peFuncDns": "[format('vd-pdns-func-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsfunc'))]",
              "peSearchDns": "[format('vd-pdns-search-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnssearch'))]",
              "peAiDns": "[format('vd-pdns-ai-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsai'))]",
              "peAutomationDns": "[format('vd-pdns-aa-{0}-{1}', parameters('purpose'), __bicep.nano16(parameters('seedPrefix'), 'pdnsaa'))]",
              "diagKv": "[format('vd-diag-kv-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagkv'))]",
              "diagSt": "[format('vd-diag-st-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagst'))]",
              "diagAcr": "[format('vd-diag-acr-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagacr'))]",
              "diagAppApi": "[format('vd-diag-app-api-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagappapi'))]",
              "diagAppUi": "[format('vd-diag-app-ui-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagappui'))]",
              "diagFunc": "[format('vd-diag-func-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagfunc'))]",
              "diagAgw": "[format('vd-diag-agw-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagagw'))]",
              "diagPsql": "[format('vd-diag-psql-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagpsql'))]",
              "diagSearch": "[format('vd-diag-search-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagsearch'))]",
              "diagAi": "[format('vd-diag-ai-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagai'))]",
              "diagAutomation": "[format('vd-diag-aa-{0}', __bicep.nano16(parameters('seedPrefix'), 'diagaa'))]",
              "diagLogic": "[format('vd-diag-logic-{0}', __bicep.nano16(parameters('seedPrefix'), 'diaglogic'))]"
            }
          },
          "resources": {},
          "outputs": {
            "names": {
              "type": "object",
              "value": "[variables('names')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "diagnostics",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "retentionDays": {
            "value": "[parameters('retentionDays')]"
          },
          "lawName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.law]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15439014609761763743"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "retentionDays": {
              "type": "int",
              "metadata": {
                "description": "Log Analytics retention in days."
              }
            },
            "lawName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('lawName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2021-12-01-preview",
              "name": "[format('{0}/{1}', parameters('lawName'), 'VibeData_Operations_CL')]",
              "properties": {
                "retentionInDays": 30,
                "totalRetentionInDays": 30,
                "schema": {
                  "name": "VibeData_Operations_CL",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "Category",
                      "type": "string"
                    },
                    {
                      "name": "CorrelationId",
                      "type": "string"
                    },
                    {
                      "name": "InstanceId",
                      "type": "string"
                    },
                    {
                      "name": "ComponentId",
                      "type": "string"
                    },
                    {
                      "name": "Operation",
                      "type": "string"
                    },
                    {
                      "name": "Status",
                      "type": "string"
                    },
                    {
                      "name": "DurationMs",
                      "type": "long"
                    },
                    {
                      "name": "Message",
                      "type": "string"
                    },
                    {
                      "name": "Details",
                      "type": "dynamic"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName'))]"
              ]
            }
          ],
          "outputs": {
            "lawId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uamiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.uami]"
          },
          "adminObjectId": {
            "value": "[parameters('adminObjectId')]"
          },
          "adminPrincipalType": {
            "value": "[parameters('adminPrincipalType')]"
          },
          "lawName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.law]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11063243419334071298"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "uamiName": {
              "type": "string",
              "metadata": {
                "description": "Name for the user-assigned managed identity."
              }
            },
            "adminObjectId": {
              "type": "string",
              "metadata": {
                "description": "Customer admin Entra object ID."
              }
            },
            "adminPrincipalType": {
              "type": "string",
              "defaultValue": "User",
              "allowedValues": [
                "User",
                "Group"
              ],
              "metadata": {
                "description": "Principal type for adminObjectId (User or Group)."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            },
            "lawName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Optional Log Analytics Workspace name for RBAC wiring."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('uamiName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), 'Contributor')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(resourceGroup().id, parameters('adminObjectId'), 'Reader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                "principalId": "[parameters('adminObjectId')]",
                "principalType": "[parameters('adminPrincipalType')]"
              }
            },
            {
              "condition": "[not(empty(parameters('lawName')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('lawName'))]",
              "name": "[guid(resourceId('Microsoft.OperationalInsights/workspaces', parameters('lawName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), 'LAW-Contrib')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '73c42c96-874c-492b-b04d-ab87d138a893')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
              ]
            }
          ],
          "outputs": {
            "uamiPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), '2023-01-31').principalId]"
            },
            "uamiClientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName')), '2023-01-31').clientId]"
            },
            "uamiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uamiName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "identity-subscription",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uamiPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7982684788310957108"
            }
          },
          "parameters": {
            "uamiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the UAMI for subscription-scope RBAC."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(subscription().id, parameters('uamiPrincipalId'), 'CostReader')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '72fafb9e-0641-4937-9268-5baf55e7ff7f')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "servicesVnetCidr": {
            "value": "[parameters('servicesVnetCidr')]"
          },
          "vnetName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.vnet]"
          },
          "nsgAppgwName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.nsgAppgw]"
          },
          "nsgAksName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.nsgAks]"
          },
          "nsgAppsvcName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.nsgAppsvc]"
          },
          "nsgPeName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.nsgPe]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10277759043657963622"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "servicesVnetCidr": {
              "type": "string",
              "metadata": {
                "description": "Services VNet CIDR block. Must be /16-/24 per RFC-64."
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name for the VNet."
              }
            },
            "nsgAppgwName": {
              "type": "string",
              "metadata": {
                "description": "NSG names."
              }
            },
            "nsgAksName": {
              "type": "string"
            },
            "nsgAppsvcName": {
              "type": "string"
            },
            "nsgPeName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('servicesVnetCidr')]"
                  ]
                },
                "subnets": [
                  {
                    "name": "snet-appgw",
                    "properties": {
                      "addressPrefix": "[cidrSubnet(parameters('servicesVnetCidr'), sub(27, int(split(parameters('servicesVnetCidr'), '/')[1])), 0)]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAppgwName'))]"
                      }
                    }
                  },
                  {
                    "name": "snet-aks",
                    "properties": {
                      "addressPrefix": "[cidrSubnet(parameters('servicesVnetCidr'), sub(25, int(split(parameters('servicesVnetCidr'), '/')[1])), 1)]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAksName'))]"
                      }
                    }
                  },
                  {
                    "name": "snet-appsvc",
                    "properties": {
                      "addressPrefix": "[cidrSubnet(parameters('servicesVnetCidr'), sub(28, int(split(parameters('servicesVnetCidr'), '/')[1])), 2)]",
                      "delegations": [
                        {
                          "name": "Microsoft.Web/serverFarms",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAppsvcName'))]"
                      }
                    }
                  },
                  {
                    "name": "snet-private-endpoints",
                    "properties": {
                      "addressPrefix": "[cidrSubnet(parameters('servicesVnetCidr'), sub(28, int(split(parameters('servicesVnetCidr'), '/')[1])), 3)]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgPeName'))]"
                      }
                    }
                  },
                  {
                    "name": "snet-psql",
                    "properties": {
                      "addressPrefix": "[cidrSubnet(parameters('servicesVnetCidr'), sub(28, int(split(parameters('servicesVnetCidr'), '/')[1])), 4)]",
                      "delegations": [
                        {
                          "name": "Microsoft.DBforPostgreSQL/flexibleServers",
                          "properties": {
                            "serviceName": "Microsoft.DBforPostgreSQL/flexibleServers"
                          }
                        }
                      ],
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Disabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAksName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAppgwName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgAppsvcName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgPeName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgAppgwName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-443-Internet",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "443",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-GatewayManager",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "65200-65535",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-AzureLoadBalancer",
                    "properties": {
                      "priority": 120,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-VNet-Inbound",
                    "properties": {
                      "priority": 130,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Deny-All-Inbound",
                    "properties": {
                      "priority": 200,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-All-Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgAksName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-VNet-Inbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Deny-Internet-Inbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-All-Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgAppsvcName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-VNet-Inbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Deny-Internet-Inbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-All-Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-04-01",
              "name": "[parameters('nsgPeName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-VNet-Inbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Deny-Internet-Inbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Allow-VNet-Outbound",
                    "properties": {
                      "priority": 100,
                      "direction": "Outbound",
                      "access": "Allow",
                      "protocol": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  },
                  {
                    "name": "Deny-Internet-Outbound",
                    "properties": {
                      "priority": 110,
                      "direction": "Outbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "destinationPortRange": "*",
                      "sourcePortRange": "*"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "subnetAppgwId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[0].id]"
            },
            "subnetAksId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[1].id]"
            },
            "subnetAppsvcId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[2].id]"
            },
            "subnetPeId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[3].id]"
            },
            "subnetPsqlId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[4].id]"
            },
            "subnetAppgwPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[0].properties.addressPrefix]"
            },
            "subnetAksPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[1].properties.addressPrefix]"
            },
            "subnetAppsvcPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[2].properties.addressPrefix]"
            },
            "subnetPePrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[3].properties.addressPrefix]"
            },
            "subnetPsqlPrefix": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName')), '2023-04-01').subnets[4].properties.addressPrefix]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "dns",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.vnet]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1629336975056086037"
            }
          },
          "parameters": {
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Services VNet to link."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "storageSuffix": "[environment().suffixes.storage]",
            "zones": [
              "privatelink.vaultcore.azure.net",
              "privatelink.postgres.database.azure.com",
              "[format('privatelink.blob.{0}', variables('storageSuffix'))]",
              "[format('privatelink.queue.{0}', variables('storageSuffix'))]",
              "[format('privatelink.table.{0}', variables('storageSuffix'))]",
              "privatelink.azurecr.io",
              "privatelink.azurewebsites.net",
              "privatelink.search.windows.net",
              "privatelink.cognitiveservices.azure.com",
              "privatelink.azure-automation.net",
              "vibedata.internal"
            ]
          },
          "resources": [
            {
              "copy": {
                "name": "privateZones",
                "count": "[length(variables('zones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2020-06-01",
              "name": "[variables('zones')[copyIndex()]]",
              "location": "global",
              "tags": "[parameters('tags')]"
            },
            {
              "copy": {
                "name": "vnetLinks",
                "count": "[length(variables('zones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', variables('zones')[copyIndex()], format('link-{0}', parameters('vnetName')))]",
              "location": "global",
              "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('zones')[copyIndex()])]"
              ]
            }
          ],
          "outputs": {
            "zoneIds": {
              "type": "object",
              "value": {
                "vault": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                "postgres": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.postgres.database.azure.com')]",
                "blob": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', format('privatelink.blob.{0}', variables('storageSuffix')))]",
                "queue": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', format('privatelink.queue.{0}', variables('storageSuffix')))]",
                "table": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', format('privatelink.table.{0}', variables('storageSuffix')))]",
                "acr": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.azurecr.io')]",
                "appsvc": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.azurewebsites.net')]",
                "search": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.search.windows.net')]",
                "ai": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.cognitiveservices.azure.com')]",
                "automation": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'privatelink.azure-automation.net')]",
                "internal": "[resourceId(resourceGroup().name, 'Microsoft.Network/privateDnsZones', 'vibedata.internal')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "security",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "kvName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.kv]"
          },
          "storageName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.storage]"
          },
          "acrName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.acr]"
          },
          "subnetPeId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetPeId.value]"
          },
          "uamiPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiPrincipalId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "zoneIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns'), '2025-04-01').outputs.zoneIds.value]"
          },
          "peKvName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peKv]"
          },
          "peStBlobName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStBlob]"
          },
          "peStQueueName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStQueue]"
          },
          "peStTableName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStTable]"
          },
          "peAcrName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAcr]"
          },
          "peKvDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peKvDns]"
          },
          "peStBlobDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStBlobDns]"
          },
          "peStQueueDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStQueueDns]"
          },
          "peStTableDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peStTableDns]"
          },
          "peAcrDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAcrDns]"
          },
          "diagKvName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagKv]"
          },
          "diagStName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagSt]"
          },
          "diagAcrName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAcr]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1986632093217677148"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "kvName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name."
              }
            },
            "storageName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account name."
              }
            },
            "acrName": {
              "type": "string",
              "metadata": {
                "description": "Container Registry name."
              }
            },
            "subnetPeId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet ID."
              }
            },
            "uamiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the UAMI for RBAC."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "zoneIds": {
              "type": "object",
              "metadata": {
                "description": "DNS zone resource IDs map (from dns module)."
              }
            },
            "peKvName": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint names from naming helper."
              }
            },
            "peStBlobName": {
              "type": "string"
            },
            "peStQueueName": {
              "type": "string"
            },
            "peStTableName": {
              "type": "string"
            },
            "peAcrName": {
              "type": "string"
            },
            "peKvDnsName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone group names from naming helper."
              }
            },
            "peStBlobDnsName": {
              "type": "string"
            },
            "peStQueueDnsName": {
              "type": "string"
            },
            "peStTableDnsName": {
              "type": "string"
            },
            "peAcrDnsName": {
              "type": "string"
            },
            "diagKvName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting names from naming helper."
              }
            },
            "diagStName": {
              "type": "string"
            },
            "diagAcrName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "storageSuffix": "[environment().suffixes.storage]",
            "blobZone": "[format('privatelink.blob.{0}', variables('storageSuffix'))]",
            "queueZone": "[format('privatelink.queue.{0}', variables('storageSuffix'))]",
            "tableZone": "[format('privatelink.table.{0}', variables('storageSuffix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-02-01",
              "name": "[parameters('kvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enablePurgeProtection": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "publicNetworkAccess": "Disabled",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": false,
                "publicNetworkAccess": "Disabled",
                "defaultToOAuthAuthentication": true
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/default/artifacts', parameters('storageName'))]",
              "properties": {
                "publicAccess": "None",
                "defaultEncryptionScope": "$account-encryption-key",
                "denyEncryptionScopeOverride": false,
                "metadata": {
                  "tier": "Cool"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "copy": {
                "name": "queues",
                "count": "[length(createArray('health-notifications-queue', 'update-notifications-queue', 'monitor-alerts-queue'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/default/{1}', parameters('storageName'), createArray('health-notifications-queue', 'update-notifications-queue', 'monitor-alerts-queue')[copyIndex()])]",
              "properties": {
                "metadata": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "copy": {
                "name": "tables",
                "count": "[length(createArray('engineHistory', 'engineDlq'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/default/{1}', parameters('storageName'), createArray('engineHistory', 'engineDlq')[copyIndex()])]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-06-01-preview",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium"
              },
              "properties": {
                "adminUserEnabled": false,
                "publicNetworkAccess": "Disabled",
                "zoneRedundancy": "Disabled",
                "dataEndpointEnabled": false
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peKvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "kv-conn",
                    "properties": {
                      "groupIds": [
                        "vault"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peKvName'), parameters('peKvDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.vaultcore.azure.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').vault]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peKvName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peStBlobName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "st-blob-conn",
                    "properties": {
                      "groupIds": [
                        "blob"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peStBlobName'), parameters('peStBlobDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[variables('blobZone')]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').blob]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStBlobName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peStQueueName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "st-queue-conn",
                    "properties": {
                      "groupIds": [
                        "queue"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peStQueueName'), parameters('peStQueueDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[variables('queueZone')]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').queue]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStQueueName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peStTableName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "st-table-conn",
                    "properties": {
                      "groupIds": [
                        "table"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peStTableName'), parameters('peStTableDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[variables('tableZone')]",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').table]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peStTableName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peAcrName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "acr-conn",
                    "properties": {
                      "groupIds": [
                        "registry"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peAcrName'), parameters('peAcrDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.azurecr.io",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').acr]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAcrName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('kvName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('kvName')), parameters('uamiPrincipalId'), 'kv-secret-officer')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('uamiPrincipalId'), 'st-blob-data-contrib')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageName')), parameters('uamiPrincipalId'), 'st-queue-data-contrib')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '19e7f393-1728-4e7a-9c12-054fda5c492f')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('uamiPrincipalId'), 'acr-pull')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), parameters('uamiPrincipalId'), 'acr-push')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8311e382-0749-4cb8-b61a-304f252e45ec')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('kvName'))]",
              "name": "[parameters('diagKvName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageName'))]",
              "name": "[parameters('diagStName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "StorageRead",
                    "enabled": true
                  },
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  },
                  {
                    "category": "StorageDelete",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
              "name": "[parameters('diagAcrName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "ContainerRegistryRepositoryEvents",
                    "enabled": true
                  },
                  {
                    "category": "ContainerRegistryLoginEvents",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
              ]
            }
          ],
          "outputs": {
            "kvId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('kvName'))]"
            },
            "storageId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageName'))]"
            },
            "acrId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "data",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "psqlName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.psql]"
          },
          "computeTier": {
            "value": "[parameters('computeTier')]"
          },
          "backupRetentionDays": {
            "value": "[parameters('backupRetentionDays')]"
          },
          "storageGB": {
            "value": "[parameters('storageGB')]"
          },
          "subnetPsqlId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetPsqlId.value]"
          },
          "uamiPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiPrincipalId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "uamiClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiClientId.value]"
          },
          "uamiId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiId.value]"
          },
          "zoneIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns'), '2025-04-01').outputs.zoneIds.value]"
          },
          "diagPsqlName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagPsql]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1894303447333964321"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "computeTier": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL compute tier SKU."
              }
            },
            "psqlName": {
              "type": "string",
              "metadata": {
                "description": "PostgreSQL server name."
              }
            },
            "subnetPsqlId": {
              "type": "string",
              "metadata": {
                "description": "Delegated subnet ID for PostgreSQL Flexible Server."
              }
            },
            "uamiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the UAMI for RBAC."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "uamiClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the UAMI for database login."
              }
            },
            "uamiId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID."
              }
            },
            "storageGB": {
              "type": "int",
              "defaultValue": 128,
              "metadata": {
                "description": "PostgreSQL storage size (GB)."
              }
            },
            "backupRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "PostgreSQL backup retention days."
              }
            },
            "zoneIds": {
              "type": "object",
              "metadata": {
                "description": "DNS zone resource IDs map (from dns module)."
              }
            },
            "diagPsqlName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting name from naming helper."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "ossrdbmsResource": "https://ossrdbms-aad.database.windows.net",
            "serverHost": "[format('{0}.postgres.database.azure.com', parameters('psqlName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/flexibleServers",
              "apiVersion": "2023-06-01-preview",
              "name": "[parameters('psqlName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('computeTier')]",
                "tier": "GeneralPurpose"
              },
              "properties": {
                "administratorLogin": null,
                "administratorLoginPassword": null,
                "version": "16",
                "storage": {
                  "storageSizeGB": "[parameters('storageGB')]",
                  "autoGrow": "Enabled"
                },
                "backup": {
                  "backupRetentionDays": "[parameters('backupRetentionDays')]",
                  "geoRedundantBackup": "Disabled"
                },
                "network": {
                  "delegatedSubnetResourceId": "[parameters('subnetPsqlId')]",
                  "privateDnsZoneArmResourceId": "[parameters('zoneIds').postgres]",
                  "publicNetworkAccess": "Disabled"
                },
                "authConfig": {
                  "activeDirectoryAuth": "Enabled",
                  "passwordAuth": "Disabled",
                  "tenantId": "[subscription().tenantId]"
                },
                "highAvailability": {
                  "mode": "Disabled"
                },
                "createMode": "Default"
              }
            },
            {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "psql-create-roles",
              "location": "[parameters('location')]",
              "kind": "AzureCLI",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "forceUpdateTag": "[guid(subscription().id, resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName')), 'psql-create-roles')]",
                "retentionInterval": "PT1H",
                "azCliVersion": "2.61.0",
                "scriptContent": "#!/usr/bin/env bash\nset -euo pipefail\nSERVER=\"${SERVER_HOST}\"\nLOGIN_USER=\"${UAMI_CLIENT_ID}\"\n\necho \"Acquiring AAD token for Postgres...\"\nACCESS_TOKEN=$(az account get-access-token --resource ${RESOURCE_URI} --query accessToken -o tsv)\nexport PGPASSWORD=\"$ACCESS_TOKEN\"\n\necho \"Creating roles vd_dbo and vd_reader if missing, and granting vd_dbo to UAMI...\"\npsql \"host=${SERVER} user=${LOGIN_USER} dbname=postgres sslmode=require\" <<'SQL'\nDO $$\nBEGIN\n  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'vd_dbo') THEN\n    CREATE ROLE \"vd_dbo\";\n  END IF;\n  IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'vd_reader') THEN\n    CREATE ROLE \"vd_reader\";\n  END IF;\nEND$$;\nGRANT \"vd_dbo\" TO \"${LOGIN_USER}\";\nSQL\n",
                "supportingScriptUris": [],
                "timeout": "PT10M",
                "environmentVariables": [
                  {
                    "name": "SERVER_HOST",
                    "value": "[variables('serverHost')]"
                  },
                  {
                    "name": "UAMI_CLIENT_ID",
                    "value": "[parameters('uamiClientId')]"
                  },
                  {
                    "name": "RESOURCE_URI",
                    "value": "[variables('ossrdbmsResource')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.DBforPostgreSQL/flexibleServers/{0}', parameters('psqlName'))]",
              "name": "[guid(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName')), parameters('uamiPrincipalId'), 'psql-admin')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '1f21df41-19d2-41e1-8a5e-3cbb7a0c2bd2')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.DBforPostgreSQL/flexibleServers/{0}', parameters('psqlName'))]",
              "name": "[parameters('diagPsqlName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "PostgreSQLLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName'))]"
              ]
            }
          ],
          "outputs": {
            "psqlId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('psqlName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "compute",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('sku')]"
          },
          "aspName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.asp]"
          },
          "appApiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.appApi]"
          },
          "appUiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.appUi]"
          },
          "funcName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.funcOps]"
          },
          "subnetAppsvcId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetAppsvcId.value]"
          },
          "subnetPeId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetPeId.value]"
          },
          "uamiId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiId.value]"
          },
          "storageAccountName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.storage]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "zoneIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns'), '2025-04-01').outputs.zoneIds.value]"
          },
          "peAppApiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAppApi]"
          },
          "peAppUiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAppUi]"
          },
          "peFuncName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peFunc]"
          },
          "peAppApiDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAppApiDns]"
          },
          "peAppUiDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAppUiDns]"
          },
          "peFuncDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peFuncDns]"
          },
          "diagAppApiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAppApi]"
          },
          "diagAppUiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAppUi]"
          },
          "diagFuncName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagFunc]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14870609158994185526"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "sku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU (RFC-64 sku)."
              }
            },
            "aspName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name."
              }
            },
            "appApiName": {
              "type": "string",
              "metadata": {
                "description": "API App name."
              }
            },
            "appUiName": {
              "type": "string",
              "metadata": {
                "description": "UI App name."
              }
            },
            "funcName": {
              "type": "string",
              "metadata": {
                "description": "Function App name."
              }
            },
            "subnetAppsvcId": {
              "type": "string",
              "metadata": {
                "description": "App Service VNet integration subnet id."
              }
            },
            "subnetPeId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet ID."
              }
            },
            "uamiId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource id."
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name for Function runtime state (identity-based)."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "zoneIds": {
              "type": "object",
              "metadata": {
                "description": "DNS zone resource IDs map (from dns module)."
              }
            },
            "peAppApiName": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint names from naming helper."
              }
            },
            "peAppUiName": {
              "type": "string"
            },
            "peFuncName": {
              "type": "string"
            },
            "peAppApiDnsName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone group names from naming helper."
              }
            },
            "peAppUiDnsName": {
              "type": "string"
            },
            "peFuncDnsName": {
              "type": "string"
            },
            "diagAppApiName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting names from naming helper."
              }
            },
            "diagAppUiName": {
              "type": "string"
            },
            "diagFuncName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "storageSuffix": "[environment().suffixes.storage]",
            "storageBlobUri": "[format('https://{0}.blob.{1}', parameters('storageAccountName'), variables('storageSuffix'))]",
            "storageQueueUri": "[format('https://{0}.queue.{1}', parameters('storageAccountName'), variables('storageSuffix'))]",
            "defaultContainer": "mcr.microsoft.com/azuredocs/aci-helloworld:latest"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-12-01",
              "name": "[parameters('aspName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "PremiumV3"
              },
              "properties": {
                "reserved": true,
                "zoneRedundant": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('appApiName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "httpsOnly": true,
                "publicNetworkAccess": "Disabled",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
                "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "alwaysOn": true,
                  "vnetRouteAllEnabled": true,
                  "scmIpSecurityRestrictionsDefaultAction": "Deny",
                  "ipSecurityRestrictionsDefaultAction": "Deny"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('appUiName')]",
              "location": "[parameters('location')]",
              "kind": "app,linux,container",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "httpsOnly": true,
                "publicNetworkAccess": "Disabled",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
                "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "alwaysOn": true,
                  "vnetRouteAllEnabled": true,
                  "scmIpSecurityRestrictionsDefaultAction": "Deny",
                  "ipSecurityRestrictionsDefaultAction": "Deny"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-12-01",
              "name": "[parameters('funcName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux,container",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "httpsOnly": true,
                "publicNetworkAccess": "Disabled",
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]",
                "virtualNetworkSubnetId": "[parameters('subnetAppsvcId')]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}', variables('defaultContainer'))]",
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "alwaysOn": true,
                  "vnetRouteAllEnabled": true,
                  "scmIpSecurityRestrictionsDefaultAction": "Deny",
                  "ipSecurityRestrictionsDefaultAction": "Deny",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage__accountName",
                      "value": "[parameters('storageAccountName')]"
                    },
                    {
                      "name": "AzureWebJobsStorage__blobServiceUri",
                      "value": "[variables('storageBlobUri')]"
                    },
                    {
                      "name": "AzureWebJobsStorage__queueServiceUri",
                      "value": "[variables('storageQueueUri')]"
                    },
                    {
                      "name": "AzureWebJobsStorage__credential",
                      "value": "ManagedIdentity"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "custom"
                    },
                    {
                      "name": "WEBSITE_CONTENTOVERVNET",
                      "value": "1"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('aspName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peAppApiName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "appapi-conn",
                    "properties": {
                      "groupIds": [
                        "sites"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peAppApiName'), parameters('peAppApiDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.azurewebsites.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAppApiName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peAppUiName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "appui-conn",
                    "properties": {
                      "groupIds": [
                        "sites"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peAppUiName'), parameters('peAppUiDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.azurewebsites.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAppUiName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peFuncName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "func-conn",
                    "properties": {
                      "groupIds": [
                        "sites"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peFuncName'), parameters('peFuncDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.azurewebsites.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').appsvc]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peFuncName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appApiName'))]",
              "name": "[parameters('diagAppApiName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('appUiName'))]",
              "name": "[parameters('diagAppUiName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "AppServiceHTTPLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceConsoleLogs",
                    "enabled": true
                  },
                  {
                    "category": "AppServiceAppLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Web/sites/{0}', parameters('funcName'))]",
              "name": "[parameters('diagFuncName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "FunctionAppLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
              ]
            }
          ],
          "outputs": {
            "appApiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('appApiName'))]"
            },
            "appUiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('appUiName'))]"
            },
            "funcId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('funcName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "gateway",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "agwName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.agw]"
          },
          "pipName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.pipAgw]"
          },
          "customerIpRanges": {
            "value": "[parameters('customerIpRanges')]"
          },
          "publisherIpRanges": {
            "value": "[parameters('publisherIpRanges')]"
          },
          "subnetAppgwId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetAppgwId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "appGwCapacity": {
            "value": "[parameters('appGwCapacity')]"
          },
          "appGwSku": {
            "value": "[parameters('appGwSku')]"
          },
          "diagAgwName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAgw]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11120080547031917859"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "agwName": {
              "type": "string",
              "metadata": {
                "description": "Application Gateway name."
              }
            },
            "pipName": {
              "type": "string",
              "metadata": {
                "description": "Public IP name for Application Gateway."
              }
            },
            "customerIpRanges": {
              "type": "array",
              "metadata": {
                "description": "Customer IP ranges for WAF allowlist."
              }
            },
            "publisherIpRanges": {
              "type": "array",
              "metadata": {
                "description": "Publisher IP ranges for WAF allowlist."
              }
            },
            "subnetAppgwId": {
              "type": "string",
              "metadata": {
                "description": "Application Gateway subnet ID."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "appGwCapacity": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Application Gateway capacity (from RFC-64 appGwCapacity display)."
              }
            },
            "appGwSku": {
              "type": "string",
              "defaultValue": "WAF_v2",
              "metadata": {
                "description": "Application Gateway SKU (from RFC-64 appGwSku display)."
              }
            },
            "diagAgwName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting name from naming helper."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "wafAllowRules",
                "count": "[length(variables('wafRules'))]",
                "input": {
                  "name": "[variables('wafRules')[copyIndex('wafAllowRules')].name]",
                  "priority": "[variables('wafRules')[copyIndex('wafAllowRules')].priority]",
                  "ruleType": "MatchRule",
                  "action": "[variables('wafRules')[copyIndex('wafAllowRules')].action]",
                  "matchConditions": [
                    {
                      "matchVariables": [
                        {
                          "variableName": "RemoteAddr"
                        }
                      ],
                      "operator": "IPMatch",
                      "negationCondition": false,
                      "matchValues": "[variables('wafRules')[copyIndex('wafAllowRules')].cidrs]"
                    }
                  ]
                }
              }
            ],
            "wafRules": [
              {
                "name": "Allow-Customer",
                "priority": 100,
                "action": "Allow",
                "cidrs": "[parameters('customerIpRanges')]"
              },
              {
                "name": "Allow-Publisher",
                "priority": 200,
                "action": "Allow",
                "cidrs": "[parameters('publisherIpRanges')]"
              }
            ],
            "wafCustomRules": "[concat(variables('wafAllowRules'), createArray(createObject('name', 'Deny-All', 'priority', 1000, 'ruleType', 'MatchRule', 'action', 'Block', 'matchConditions', createArray(createObject('matchVariables', createArray(createObject('variableName', 'RemoteAddr')), 'operator', 'IPMatch', 'negationCondition', false(), 'matchValues', createArray('0.0.0.0/0'))))))]",
            "wafPolicyName": "[format('{0}-waf', parameters('agwName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-04-01",
              "name": "[parameters('pipName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies",
              "apiVersion": "2022-09-01",
              "name": "[variables('wafPolicyName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "policySettings": {
                  "mode": "Prevention",
                  "state": "Enabled",
                  "requestBodyCheck": true
                },
                "customRules": "[variables('wafCustomRules')]",
                "managedRules": {
                  "managedRuleSets": [
                    {
                      "ruleSetType": "OWASP",
                      "ruleSetVersion": "3.2"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2021-08-01",
              "name": "[parameters('agwName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('appGwSku')]",
                  "tier": "WAF_v2",
                  "capacity": "[parameters('appGwCapacity')]"
                },
                "enableHttp2": true,
                "gatewayIPConfigurations": [
                  {
                    "name": "appgw-ipconfig",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetAppgwId')]"
                      }
                    }
                  }
                ],
                "frontendIPConfigurations": [
                  {
                    "name": "appgw-feip",
                    "properties": {
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]"
                      }
                    }
                  }
                ],
                "frontendPorts": [
                  {
                    "name": "https-port",
                    "properties": {
                      "port": 443
                    }
                  }
                ],
                "backendAddressPools": [],
                "backendHttpSettingsCollection": [
                  {
                    "name": "default-setting",
                    "properties": {
                      "protocol": "Https",
                      "port": 443,
                      "pickHostNameFromBackendAddress": true,
                      "requestTimeout": 60,
                      "connectionDraining": {
                        "enabled": true,
                        "drainTimeoutInSec": 60
                      }
                    }
                  }
                ],
                "httpListeners": [],
                "requestRoutingRules": [],
                "probes": [],
                "firewallPolicy": {
                  "id": "[resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', variables('wafPolicyName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/ApplicationGatewayWebApplicationFirewallPolicies', variables('wafPolicyName'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('pipName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Network/applicationGateways/{0}', parameters('agwName'))]",
              "name": "[parameters('diagAgwName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "ApplicationGatewayAccessLog",
                    "enabled": true
                  },
                  {
                    "category": "ApplicationGatewayPerformanceLog",
                    "enabled": true
                  },
                  {
                    "category": "ApplicationGatewayFirewallLog",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/applicationGateways', parameters('agwName'))]"
              ]
            }
          ],
          "outputs": {
            "appGwId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/applicationGateways', parameters('agwName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "ai",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "aiServicesTier": {
            "value": "[parameters('aiServicesTier')]"
          },
          "searchName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.search]"
          },
          "aiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.ai]"
          },
          "subnetPeId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetPeId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "uamiPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiPrincipalId.value]"
          },
          "zoneIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns'), '2025-04-01').outputs.zoneIds.value]"
          },
          "peSearchName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peSearch]"
          },
          "peAiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAi]"
          },
          "peSearchDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peSearchDns]"
          },
          "peAiDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAiDns]"
          },
          "diagSearchName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagSearch]"
          },
          "diagAiName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAi]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7999979219340543305"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "aiServicesTier": {
              "type": "string",
              "metadata": {
                "description": "AI Services tier."
              }
            },
            "searchName": {
              "type": "string",
              "metadata": {
                "description": "AI Search service name."
              }
            },
            "aiName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry (Cognitive Services) name."
              }
            },
            "subnetPeId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet ID."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "zoneIds": {
              "type": "object",
              "metadata": {
                "description": "DNS zone resource IDs map (from dns module)."
              }
            },
            "uamiPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the UAMI for RBAC (optional)."
              }
            },
            "peSearchName": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint names from naming helper."
              }
            },
            "peAiName": {
              "type": "string"
            },
            "peSearchDnsName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone group names from naming helper."
              }
            },
            "peAiDnsName": {
              "type": "string"
            },
            "diagSearchName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting names from naming helper."
              }
            },
            "diagAiName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('searchName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('aiServicesTier')]"
              },
              "properties": {
                "replicaCount": 1,
                "partitionCount": 1,
                "publicNetworkAccess": "disabled",
                "hostingMode": "default"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('aiName')]",
              "location": "[parameters('location')]",
              "kind": "CognitiveServices",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "disabled"
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peSearchName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "search-conn",
                    "properties": {
                      "groupIds": [
                        "searchService"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Search/searchServices', parameters('searchName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('searchName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peSearchName'), parameters('peSearchDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.search.windows.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').search]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peSearchName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peAiName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "ai-conn",
                    "properties": {
                      "groupIds": [
                        "account"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peAiName'), parameters('peAiDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.cognitiveservices.azure.com",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').ai]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAiName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchName'))]",
              "name": "[parameters('diagSearchName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('searchName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiName'))]",
              "name": "[parameters('diagAiName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('uamiPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.CognitiveServices/accounts/{0}', parameters('aiName'))]",
              "name": "[guid(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName')), parameters('uamiPrincipalId'), 'ai-contrib')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a97b65f3-24c7-4388-baec-2e87135dc908')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('uamiPrincipalId')))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Search/searchServices/{0}', parameters('searchName'))]",
              "name": "[guid(resourceId('Microsoft.Search/searchServices', parameters('searchName')), parameters('uamiPrincipalId'), 'search-contrib')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'de139f84-1756-47ae-9be6-808fbbe84772')]",
                "principalId": "[parameters('uamiPrincipalId')]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Search/searchServices', parameters('searchName'))]"
              ]
            }
          ],
          "outputs": {
            "searchId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('searchName'))]"
            },
            "aiId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "automation",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "automationName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.automation]"
          },
          "uamiId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiId.value]"
          },
          "adminObjectId": {
            "value": "[parameters('adminObjectId')]"
          },
          "adminPrincipalType": {
            "value": "[parameters('adminPrincipalType')]"
          },
          "subnetPeId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetPeId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "zoneIds": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns'), '2025-04-01').outputs.zoneIds.value]"
          },
          "peAutomationName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAutomation]"
          },
          "peAutomationDnsName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.peAutomationDns]"
          },
          "diagAutomationName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagAutomation]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12877304489203540352"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "automationName": {
              "type": "string",
              "metadata": {
                "description": "Automation Account name."
              }
            },
            "uamiId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource id."
              }
            },
            "adminObjectId": {
              "type": "string",
              "metadata": {
                "description": "Admin Object ID for customer (for Automation role)."
              }
            },
            "adminPrincipalType": {
              "type": "string",
              "defaultValue": "User",
              "allowedValues": [
                "User",
                "Group"
              ],
              "metadata": {
                "description": "Principal type for adminObjectId (User or Group)."
              }
            },
            "subnetPeId": {
              "type": "string",
              "metadata": {
                "description": "Private Endpoints subnet ID."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "zoneIds": {
              "type": "object",
              "metadata": {
                "description": "DNS zone resource IDs map (from dns module)."
              }
            },
            "peAutomationName": {
              "type": "string",
              "metadata": {
                "description": "Private endpoint name from naming helper."
              }
            },
            "peAutomationDnsName": {
              "type": "string",
              "metadata": {
                "description": "Private DNS zone group name from naming helper."
              }
            },
            "diagAutomationName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting name from naming helper."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Automation/automationAccounts",
              "apiVersion": "2021-06-22",
              "name": "[parameters('automationName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "publicNetworkAccess": false,
                "disableLocalAuth": true
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-05-01",
              "name": "[parameters('peAutomationName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetPeId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "automation-conn",
                    "properties": {
                      "groupIds": [
                        "AzureAutomation"
                      ],
                      "privateLinkServiceId": "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationName'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('peAutomationName'), parameters('peAutomationDnsName'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink.azure-automation.net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('zoneIds').automation]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', parameters('peAutomationName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Automation/automationAccounts/{0}', parameters('automationName'))]",
              "name": "[parameters('diagAutomationName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "JobLogs",
                    "enabled": true
                  },
                  {
                    "category": "JobStreams",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.Automation/automationAccounts/{0}', parameters('automationName'))]",
              "name": "[guid(resourceId('Microsoft.Automation/automationAccounts', parameters('automationName')), parameters('adminObjectId'), 'automation-job-operator')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '4fe576fe-1146-4730-92eb-48519fa6bf9f')]",
                "principalId": "[parameters('adminObjectId')]",
                "principalType": "[parameters('adminPrincipalType')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationName'))]"
              ]
            }
          ],
          "outputs": {
            "automationId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Automation/automationAccounts', parameters('automationName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'dns')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'network')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logic",
      "resourceGroup": "[parameters('resourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "logicName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.logic]"
          },
          "uamiId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity'), '2025-04-01').outputs.uamiId.value]"
          },
          "lawId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics'), '2025-04-01').outputs.lawId.value]"
          },
          "diagLogicName": {
            "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value.diagLogic]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "128747929723273104"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "logicName": {
              "type": "string",
              "metadata": {
                "description": "Logic App name (Consumption)."
              }
            },
            "uamiId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource id."
              }
            },
            "lawId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "diagLogicName": {
              "type": "string",
              "metadata": {
                "description": "Diagnostic setting name from naming helper."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Logic/workflows",
              "apiVersion": "2019-05-01",
              "name": "[parameters('logicName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "state": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Logic/workflows/{0}', parameters('logicName'))]",
              "name": "[parameters('diagLogicName')]",
              "properties": {
                "workspaceId": "[parameters('lawId')]",
                "logs": [
                  {
                    "category": "WorkflowRuntime",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Logic/workflows', parameters('logicName'))]"
              ]
            }
          ],
          "outputs": {
            "logicId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Logic/workflows', parameters('logicName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'diagnostics')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroup')), 'Microsoft.Resources/deployments', 'identity')]",
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'naming')]"
      ]
    }
  ],
  "outputs": {
    "names": {
      "type": "object",
      "value": "[reference(subscriptionResourceId('Microsoft.Resources/deployments', 'naming'), '2025-04-01').outputs.names.value]"
    }
  }
}