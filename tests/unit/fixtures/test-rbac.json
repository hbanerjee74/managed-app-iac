{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
    "_EXPERIMENTAL_FEATURES_ENABLED": [
      "Asserts"
    ],
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "11698047034695608788"
    }
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name for naming seed."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region for deployment (RFC-64: location)."
      }
    },
    "customerAdminObjectId": {
      "type": "string",
      "metadata": {
        "description": "Customer Admin Object ID."
      }
    },
    "customerAdminPrincipalType": {
      "type": "string",
      "metadata": {
        "description": "Customer Admin Principal Type."
      }
    }
  },
  "variables": {
    "mockIdentityOutputs": {
      "uamiPrincipalId": "00000000-0000-0000-0000-000000000000",
      "uamiId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/test-uami"
    },
    "mockDiagnosticsOutputs": {
      "lawId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.OperationalInsights/workspaces/test-law"
    },
    "mockKvId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.KeyVault/vaults/test-kv",
    "mockStorageId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.Storage/storageAccounts/testst",
    "mockAcrId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.ContainerRegistry/registries/testacr",
    "mockSearchId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.Search/searchServices/test-search",
    "mockAiId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.CognitiveServices/accounts/test-ai",
    "mockAutomationId": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/test-rg/providers/Microsoft.Automation/automationAccounts/test-automation"
  },
  "resources": {
    "naming": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "naming",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourceGroupName": {
            "value": "[parameters('resourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9599786196098502373"
            }
          },
          "functions": [
            {
              "namespace": "__bicep",
              "members": {
                "nano16": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "seed"
                    },
                    {
                      "type": "string",
                      "name": "suffix"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[toLower(format('{0}{1}', substring(uniqueString(format('{0}-{1}-a', parameters('seed'), parameters('suffix'))), 0, 8), substring(uniqueString(format('{0}-{1}-b', parameters('seed'), parameters('suffix'))), 0, 8)))]"
                  }
                },
                "nano8": {
                  "parameters": [
                    {
                      "type": "string",
                      "name": "seed"
                    },
                    {
                      "type": "string",
                      "name": "suffix"
                    }
                  ],
                  "output": {
                    "type": "string",
                    "value": "[toLower(substring(uniqueString(format('{0}-{1}', parameters('seed'), parameters('suffix'))), 0, 8))]"
                  }
                }
              }
            }
          ],
          "parameters": {
            "resourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Resource group name used as seed for deterministic nanoid generation."
              }
            }
          },
          "variables": {
            "seedPrefix": "[parameters('resourceGroupName')]",
            "names": {
              "uami": "[format('vd-uami-{0}', __bicep.nano16(variables('seedPrefix'), 'uami'))]",
              "vnet": "[format('vd-vnet-{0}', __bicep.nano16(variables('seedPrefix'), 'vnet'))]",
              "nsgAppgw": "[format('vd-nsg-appgw-{0}', __bicep.nano16(variables('seedPrefix'), 'nsgappgw'))]",
              "nsgAks": "[format('vd-nsg-aks-{0}', __bicep.nano16(variables('seedPrefix'), 'nsgaks'))]",
              "nsgAppsvc": "[format('vd-nsg-appsvc-{0}', __bicep.nano16(variables('seedPrefix'), 'nsgappsvc'))]",
              "nsgPe": "[format('vd-nsg-pe-{0}', __bicep.nano16(variables('seedPrefix'), 'nsgpe'))]",
              "kv": "[format('vd-kv-{0}', __bicep.nano16(variables('seedPrefix'), 'kv'))]",
              "storage": "[format('vdst{0}', __bicep.nano8(variables('seedPrefix'), 'st'))]",
              "acr": "[format('vdacr{0}', __bicep.nano8(variables('seedPrefix'), 'acr'))]",
              "law": "[format('vd-law-{0}', __bicep.nano16(variables('seedPrefix'), 'law'))]",
              "asp": "[format('vd-asp-{0}', __bicep.nano16(variables('seedPrefix'), 'asp'))]",
              "agw": "[format('vd-agw-{0}', __bicep.nano16(variables('seedPrefix'), 'agw'))]",
              "pipAgw": "[format('vd-pip-agw-{0}', __bicep.nano16(variables('seedPrefix'), 'pipagw'))]",
              "psql": "[format('vd-psql-{0}', __bicep.nano16(variables('seedPrefix'), 'psql'))]",
              "search": "[format('vd-search-{0}', __bicep.nano16(variables('seedPrefix'), 'search'))]",
              "ai": "[format('vd-ai-{0}', __bicep.nano16(variables('seedPrefix'), 'ai'))]",
              "automation": "[format('vd-aa-{0}', __bicep.nano16(variables('seedPrefix'), 'aa'))]",
              "vm": "[format('vd-vm-{0}', __bicep.nano16(variables('seedPrefix'), 'vm'))]",
              "bastion": "[format('vd-bastion-{0}', __bicep.nano16(variables('seedPrefix'), 'bastion'))]",
              "pipBastion": "[format('vd-pip-bastion-{0}', __bicep.nano16(variables('seedPrefix'), 'pipbastion'))]",
              "peKv": "[format('vd-pe-kv-{0}', __bicep.nano16(variables('seedPrefix'), 'pekv'))]",
              "peStBlob": "[format('vd-pe-st-blob-{0}', __bicep.nano16(variables('seedPrefix'), 'pestblob'))]",
              "peStQueue": "[format('vd-pe-st-queue-{0}', __bicep.nano16(variables('seedPrefix'), 'pestqueue'))]",
              "peStTable": "[format('vd-pe-st-table-{0}', __bicep.nano16(variables('seedPrefix'), 'pesttable'))]",
              "peAcr": "[format('vd-pe-acr-{0}', __bicep.nano16(variables('seedPrefix'), 'peacr'))]",
              "peSearch": "[format('vd-pe-search-{0}', __bicep.nano16(variables('seedPrefix'), 'pesearch'))]",
              "peAi": "[format('vd-pe-ai-{0}', __bicep.nano16(variables('seedPrefix'), 'peai'))]",
              "peAutomation": "[format('vd-pe-aa-{0}', __bicep.nano16(variables('seedPrefix'), 'peaa'))]",
              "peKvDns": "[format('vd-pdns-kv-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnskv'))]",
              "peStBlobDns": "[format('vd-pdns-st-blob-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnsstblob'))]",
              "peStQueueDns": "[format('vd-pdns-st-queue-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnsstqueue'))]",
              "peStTableDns": "[format('vd-pdns-st-table-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnssttable'))]",
              "peAcrDns": "[format('vd-pdns-acr-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnsacr'))]",
              "peSearchDns": "[format('vd-pdns-search-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnssearch'))]",
              "peAiDns": "[format('vd-pdns-ai-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnsai'))]",
              "peAutomationDns": "[format('vd-pdns-aa-{0}', __bicep.nano16(variables('seedPrefix'), 'pdnsaa'))]",
              "diagKv": "[format('vd-diag-kv-{0}', __bicep.nano16(variables('seedPrefix'), 'diagkv'))]",
              "diagSt": "[format('vd-diag-st-{0}', __bicep.nano16(variables('seedPrefix'), 'diagst'))]",
              "diagAcr": "[format('vd-diag-acr-{0}', __bicep.nano16(variables('seedPrefix'), 'diagacr'))]",
              "diagAgw": "[format('vd-diag-agw-{0}', __bicep.nano16(variables('seedPrefix'), 'diagagw'))]",
              "diagPsql": "[format('vd-diag-psql-{0}', __bicep.nano16(variables('seedPrefix'), 'diagpsql'))]",
              "diagSearch": "[format('vd-diag-search-{0}', __bicep.nano16(variables('seedPrefix'), 'diagsearch'))]",
              "diagAi": "[format('vd-diag-ai-{0}', __bicep.nano16(variables('seedPrefix'), 'diagai'))]",
              "diagAutomation": "[format('vd-diag-aa-{0}', __bicep.nano16(variables('seedPrefix'), 'diagaa'))]"
            }
          },
          "resources": {},
          "outputs": {
            "names": {
              "type": "object",
              "value": "[variables('names')]"
            }
          }
        }
      }
    },
    "rbac": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "uamiPrincipalId": {
            "value": "[variables('mockIdentityOutputs').uamiPrincipalId]"
          },
          "uamiId": {
            "value": "[variables('mockIdentityOutputs').uamiId]"
          },
          "customerAdminObjectId": {
            "value": "[parameters('customerAdminObjectId')]"
          },
          "customerAdminPrincipalType": {
            "value": "[parameters('customerAdminPrincipalType')]"
          },
          "lawId": {
            "value": "[variables('mockDiagnosticsOutputs').lawId]"
          },
          "lawName": {
            "value": "[reference('naming').outputs.names.value.law]"
          },
          "kvId": {
            "value": "[variables('mockKvId')]"
          },
          "storageId": {
            "value": "[variables('mockStorageId')]"
          },
          "acrId": {
            "value": "[variables('mockAcrId')]"
          },
          "searchId": {
            "value": "[variables('mockSearchId')]"
          },
          "aiId": {
            "value": "[variables('mockAiId')]"
          },
          "automationId": {
            "value": "[variables('mockAutomationId')]"
          },
          "isManagedApplication": {
            "value": false
          },
          "tags": {
            "value": {}
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.1-experimental",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
            "_EXPERIMENTAL_FEATURES_ENABLED": [
              "Asserts"
            ],
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "13432088729274504080"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "uamiPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity principal ID."
              }
            },
            "uamiId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID."
              }
            },
            "customerAdminObjectId": {
              "type": "string",
              "metadata": {
                "description": "Customer admin Entra object ID."
              }
            },
            "customerAdminPrincipalType": {
              "type": "string",
              "defaultValue": "User",
              "allowedValues": [
                "User",
                "Group"
              ],
              "metadata": {
                "description": "Principal type for customerAdminObjectId (User or Group)."
              }
            },
            "lawId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace resource ID."
              }
            },
            "lawName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace name."
              }
            },
            "kvId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID."
              }
            },
            "storageId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account resource ID."
              }
            },
            "acrId": {
              "type": "string",
              "metadata": {
                "description": "Container Registry resource ID."
              }
            },
            "searchId": {
              "type": "string",
              "metadata": {
                "description": "Azure AI Search resource ID."
              }
            },
            "aiId": {
              "type": "string",
              "metadata": {
                "description": "Cognitive Services resource ID."
              }
            },
            "automationId": {
              "type": "string",
              "metadata": {
                "description": "Automation Account resource ID."
              }
            },
            "automationName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Automation Account name (for runbook creation)."
              }
            },
            "isManagedApplication": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Whether this is a managed application deployment (cross-tenant). Set to false for same-tenant testing."
              }
            },
            "publisherAdminObjectId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Publisher admin Entra object ID (for managed applications only)."
              }
            },
            "publisherAdminPrincipalType": {
              "type": "string",
              "defaultValue": "User",
              "allowedValues": [
                "User",
                "Group"
              ],
              "metadata": {
                "description": "Principal type for publisherAdminObjectId (User or Group)."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags to apply."
              }
            }
          },
          "variables": {
            "rbacUamiScript": "# PowerShell script to assign RBAC roles for UAMI (User-Assigned Managed Identity)\n# This script is executed by Azure deploymentScripts resource or automation runbook\n# Parameters are passed via environment variables or script parameters\n\nparam(\n    [string]$ResourceGroupId = $env:RESOURCE_GROUP_ID,\n    [string]$UamiPrincipalId = $env:UAMI_PRINCIPAL_ID,\n    [string]$UamiId = $env:UAMI_ID,\n    [string]$LawId = $env:LAW_ID,\n    [string]$LawName = $env:LAW_NAME,\n    [string]$KvId = $env:KV_ID,\n    [string]$StorageId = $env:STORAGE_ID,\n    [string]$AcrId = $env:ACR_ID,\n    [string]$SearchId = $env:SEARCH_ID,\n    [string]$AiId = $env:AI_ID,\n    [string]$AutomationId = $env:AUTOMATION_ID,\n    [string]$IsManagedApplication = $env:IS_MANAGED_APPLICATION\n)\n\n$ErrorActionPreference = \"Stop\"\n\nWrite-Host \"Starting UAMI RBAC role assignment script...\"\nWrite-Host \"Resource Group ID: $ResourceGroupId\"\nWrite-Host \"UAMI Principal ID: $UamiPrincipalId\"\nWrite-Host \"UAMI ID: $UamiId\"\n\n# Validate required parameters\nif ([string]::IsNullOrEmpty($ResourceGroupId)) {\n    Write-Error \"RESOURCE_GROUP_ID environment variable is required\"\n    exit 1\n}\n\nif ([string]::IsNullOrEmpty($UamiPrincipalId)) {\n    Write-Error \"UAMI_PRINCIPAL_ID environment variable is required\"\n    exit 1\n}\n\nif ([string]::IsNullOrEmpty($UamiId)) {\n    Write-Error \"UAMI_ID environment variable is required\"\n    exit 1\n}\n\n# Role definition IDs\n$roleDefinitions = @{\n    Contributor = \"b24988ac-6180-42a0-ab88-20f7382dd24c\"\n    LogAnalyticsContributor = \"73c42c96-874c-492b-b04d-ab87d138a893\"\n    KeyVaultSecretsOfficer = \"b86a8fe4-44ce-4948-aee5-eccb2c155cd7\"\n    StorageBlobDataContributor = \"ba92f5b4-2d11-453d-a403-e96b0029c9fe\"\n    StorageQueueDataContributor = \"974c5e8b-45b9-4653-ba55-5f855dd0fb88\"\n    StorageTableDataContributor = \"0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3\"\n    AcrPull = \"7f951dda-4ed3-4680-a7ca-43fe172d538d\"\n    AcrPush = \"8311e382-0749-4cb8-b61a-304f252e45ec\"\n    SearchServiceContributor = \"de139f84-1756-47ae-9be6-808fbbe84772\"\n    CognitiveServicesContributor = \"a97b65f3-24c7-4388-baec-2e87135dc908\"\n    AutomationJobOperator = \"4fe576fe-1146-4730-92eb-48519fa6bf9f\"\n}\n\nfunction Get-DeterministicGuid {\n    param(\n        [string]$Scope,\n        [string]$PrincipalId,\n        [string]$Suffix\n    )\n    \n    # Generate deterministic GUID similar to Bicep guid() function\n    # Bicep's guid() uses a deterministic algorithm based on the input string\n    # We'll use MD5 hash to create a deterministic GUID from the inputs\n    $inputString = \"$Scope-$PrincipalId-$Suffix\"\n    $md5 = [System.Security.Cryptography.MD5]::Create()\n    $hash = $md5.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($inputString))\n    \n    # Create a GUID from the MD5 hash (16 bytes)\n    # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n    $guidBytes = New-Object byte[] 16\n    [Array]::Copy($hash, 0, $guidBytes, 0, 16)\n    \n    # Set version bits (version 4 UUID uses bits 12-15 = 0100)\n    $guidBytes[6] = ($guidBytes[6] -band 0x0F) -bor 0x40\n    # Set variant bits (bits 6-7 of byte 8 = 10)\n    $guidBytes[8] = ($guidBytes[8] -band 0x3F) -bor 0x80\n    \n    $guid = New-Object System.Guid(,$guidBytes)\n    return $guid.ToString()\n}\n\nfunction New-RoleAssignment {\n    param(\n        [string]$Scope,\n        [string]$RoleDefinitionId,\n        [string]$PrincipalId,\n        [string]$PrincipalType,\n        [string]$RoleAssignmentName,\n        [string]$DelegatedManagedIdentityResourceId = $null\n    )\n    \n    Write-Host \"Assigning role $RoleAssignmentName at scope $Scope...\"\n    \n    try {\n        # Check if role assignment already exists\n        $existing = az role assignment list --scope $Scope --assignee $PrincipalId --role $RoleDefinitionId --query \"[?name=='$RoleAssignmentName']\" -o json | ConvertFrom-Json\n        \n        if ($existing -and $existing.Count -gt 0) {\n            Write-Host \"Role assignment $RoleAssignmentName already exists, skipping...\" -ForegroundColor Yellow\n            return\n        }\n        \n        # Build Azure CLI command arguments\n        $azArgs = @(\n            \"role\", \"assignment\", \"create\",\n            \"--scope\", $Scope,\n            \"--role\", $RoleDefinitionId,\n            \"--assignee\", $PrincipalId,\n            \"--assignee-principal-type\", $PrincipalType,\n            \"--name\", $RoleAssignmentName\n        )\n        \n        if ($DelegatedManagedIdentityResourceId) {\n            $azArgs += \"--delegated-managed-identity-resource-id\"\n            $azArgs += $DelegatedManagedIdentityResourceId\n        }\n        \n        # Create role assignment\n        az @azArgs | Out-Null\n        \n        if ($LASTEXITCODE -eq 0) {\n            Write-Host \"Successfully assigned role $RoleAssignmentName\" -ForegroundColor Green\n        } else {\n            Write-Warning \"Failed to assign role $RoleAssignmentName (exit code: $LASTEXITCODE)\"\n        }\n    } catch {\n        Write-Warning \"Error assigning role $RoleAssignmentName : $_\"\n    }\n}\n\n# ============================================================================\n# UAMI RBAC ASSIGNMENTS\n# ============================================================================\n\nWrite-Host \"`n=== Assigning UAMI RBAC Roles ===\" -ForegroundColor Cyan\n\n# UAMI: Contributor on Resource Group\n$delegatedUamiId = ($IsManagedApplication -eq \"true\") ? $UamiId : $null\n$rgContributorName = Get-DeterministicGuid -Scope $ResourceGroupId -PrincipalId $UamiId -Suffix \"Contributor\"\nNew-RoleAssignment -Scope $ResourceGroupId `\n    -RoleDefinitionId $roleDefinitions.Contributor `\n    -PrincipalId $UamiPrincipalId `\n    -PrincipalType \"ServicePrincipal\" `\n    -RoleAssignmentName $rgContributorName `\n    -DelegatedManagedIdentityResourceId $delegatedUamiId\n\n# UAMI: Log Analytics Contributor (if LAW provided)\nif (![string]::IsNullOrEmpty($LawId) -and ![string]::IsNullOrEmpty($LawName)) {\n    $lawContributorName = Get-DeterministicGuid -Scope $LawId -PrincipalId $UamiId -Suffix \"LAW-Contrib\"\n    New-RoleAssignment -Scope $LawId `\n        -RoleDefinitionId $roleDefinitions.LogAnalyticsContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $lawContributorName `\n        -DelegatedManagedIdentityResourceId $delegatedUamiId\n}\n\n# UAMI: Key Vault Secrets Officer\nif (![string]::IsNullOrEmpty($KvId)) {\n    $kvSecretsOfficerName = Get-DeterministicGuid -Scope $KvId -PrincipalId $UamiPrincipalId -Suffix \"kv-secret-officer\"\n    New-RoleAssignment -Scope $KvId `\n        -RoleDefinitionId $roleDefinitions.KeyVaultSecretsOfficer `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $kvSecretsOfficerName\n}\n\n# UAMI: Storage Blob Data Contributor\nif (![string]::IsNullOrEmpty($StorageId)) {\n    $stBlobContribName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $UamiPrincipalId -Suffix \"st-blob-data-contrib\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageBlobDataContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $stBlobContribName\n    \n    # UAMI: Storage Queue Data Contributor\n    $stQueueContribName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $UamiPrincipalId -Suffix \"st-queue-data-contrib\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageQueueDataContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $stQueueContribName\n    \n    # UAMI: Storage Table Data Contributor\n    $stTableContribName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $UamiPrincipalId -Suffix \"st-table-data-contrib\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageTableDataContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $stTableContribName\n}\n\n# UAMI: AcrPull\nif (![string]::IsNullOrEmpty($AcrId)) {\n    $acrPullName = Get-DeterministicGuid -Scope $AcrId -PrincipalId $UamiPrincipalId -Suffix \"acr-pull\"\n    New-RoleAssignment -Scope $AcrId `\n        -RoleDefinitionId $roleDefinitions.AcrPull `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $acrPullName\n    \n    # UAMI: AcrPush\n    $acrPushName = Get-DeterministicGuid -Scope $AcrId -PrincipalId $UamiPrincipalId -Suffix \"acr-push\"\n    New-RoleAssignment -Scope $AcrId `\n        -RoleDefinitionId $roleDefinitions.AcrPush `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $acrPushName\n}\n\n# UAMI: Search Service Contributor\nif (![string]::IsNullOrEmpty($SearchId)) {\n    $searchContribName = Get-DeterministicGuid -Scope $SearchId -PrincipalId $UamiPrincipalId -Suffix \"search-contrib\"\n    New-RoleAssignment -Scope $SearchId `\n        -RoleDefinitionId $roleDefinitions.SearchServiceContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $searchContribName\n}\n\n# UAMI: Cognitive Services Contributor\nif (![string]::IsNullOrEmpty($AiId)) {\n    $aiContribName = Get-DeterministicGuid -Scope $AiId -PrincipalId $UamiPrincipalId -Suffix \"ai-contrib\"\n    New-RoleAssignment -Scope $AiId `\n        -RoleDefinitionId $roleDefinitions.CognitiveServicesContributor `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $aiContribName\n}\n\n# UAMI: Automation Job Operator\nif (![string]::IsNullOrEmpty($AutomationId)) {\n    $automationJobOpName = Get-DeterministicGuid -Scope $AutomationId -PrincipalId $UamiPrincipalId -Suffix \"automation-job-operator\"\n    New-RoleAssignment -Scope $AutomationId `\n        -RoleDefinitionId $roleDefinitions.AutomationJobOperator `\n        -PrincipalId $UamiPrincipalId `\n        -PrincipalType \"ServicePrincipal\" `\n        -RoleAssignmentName $automationJobOpName\n}\n\nWrite-Host \"`nUAMI RBAC role assignment script completed successfully\" -ForegroundColor Green\n",
            "rbacCustomerAdminScript": "# PowerShell script to assign RBAC roles for Admin (Customer Administrator)\n# This script is executed by Azure deploymentScripts resource or automation runbook\n# Parameters are passed via environment variables or script parameters\n\nparam(\n    [string]$ResourceGroupId = $env:RESOURCE_GROUP_ID,\n    [string]$CustomerAdminObjectId = $env:CUSTOMER_ADMIN_OBJECT_ID,\n    [string]$CustomerAdminPrincipalType = $env:CUSTOMER_ADMIN_PRINCIPAL_TYPE,\n    [string]$KvId = $env:KV_ID,\n    [string]$StorageId = $env:STORAGE_ID,\n    [string]$AcrId = $env:ACR_ID,\n    [string]$SearchId = $env:SEARCH_ID,\n    [string]$AiId = $env:AI_ID,\n    [string]$AutomationId = $env:AUTOMATION_ID\n)\n\n$ErrorActionPreference = \"Stop\"\n\nWrite-Host \"Starting Customer Admin RBAC role assignment script...\"\nWrite-Host \"Resource Group ID: $ResourceGroupId\"\nWrite-Host \"Customer Admin Object ID: $CustomerAdminObjectId\"\nWrite-Host \"Customer Admin Principal Type: $(if ([string]::IsNullOrEmpty($CustomerAdminPrincipalType)) { 'User (default)' } else { $CustomerAdminPrincipalType })\"\n\n# Validate required parameters\nif ([string]::IsNullOrEmpty($ResourceGroupId)) {\n    Write-Error \"RESOURCE_GROUP_ID environment variable is required\"\n    exit 1\n}\n\nif ([string]::IsNullOrEmpty($CustomerAdminObjectId)) {\n    Write-Error \"CUSTOMER_ADMIN_OBJECT_ID environment variable is required\"\n    exit 1\n}\n\n# Role definition IDs\n$roleDefinitions = @{\n    Reader = \"acdd72a7-3385-48ef-bd42-f606fba81ae7\"\n    KeyVaultSecretsUser = \"4633458b-17de-408a-b874-0445c86b69e6\"\n    StorageBlobDataReader = \"2a2b9908-6ea1-4ae2-8e65-a410df84e7d1\"\n    StorageQueueDataReader = \"19e7f393-937e-4f77-808e-945a386e9b0a\"\n    StorageTableDataReader = \"76199698-9eea-4c19-bc75-cec21354c015\"\n    AcrPull = \"7f951dda-4ed3-4680-a7ca-43fe172d538d\"\n    SearchServiceReader = \"88308d66-4209-4f3e-9b77-8200b49e9c22\"\n    CognitiveServicesUser = \"a97b65f3-24c7-4388-baec-2e87135dc908\"\n    AutomationJobOperator = \"4fe576fe-1146-4730-92eb-48519fa6bf9f\"\n}\n\nfunction Get-DeterministicGuid {\n    param(\n        [string]$Scope,\n        [string]$PrincipalId,\n        [string]$Suffix\n    )\n    \n    # Generate deterministic GUID similar to Bicep guid() function\n    # Bicep's guid() uses a deterministic algorithm based on the input string\n    # We'll use MD5 hash to create a deterministic GUID from the inputs\n    $inputString = \"$Scope-$PrincipalId-$Suffix\"\n    $md5 = [System.Security.Cryptography.MD5]::Create()\n    $hash = $md5.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($inputString))\n    \n    # Create a GUID from the MD5 hash (16 bytes)\n    # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n    $guidBytes = New-Object byte[] 16\n    [Array]::Copy($hash, 0, $guidBytes, 0, 16)\n    \n    # Set version bits (version 4 UUID uses bits 12-15 = 0100)\n    $guidBytes[6] = ($guidBytes[6] -band 0x0F) -bor 0x40\n    # Set variant bits (bits 6-7 of byte 8 = 10)\n    $guidBytes[8] = ($guidBytes[8] -band 0x3F) -bor 0x80\n    \n    $guid = New-Object System.Guid(,$guidBytes)\n    return $guid.ToString()\n}\n\nfunction New-RoleAssignment {\n    param(\n        [string]$Scope,\n        [string]$RoleDefinitionId,\n        [string]$PrincipalId,\n        [string]$PrincipalType,\n        [string]$RoleAssignmentName\n    )\n    \n    Write-Host \"Assigning role $RoleAssignmentName at scope $Scope...\"\n    \n    try {\n        # Check if role assignment already exists\n        $existing = az role assignment list --scope $Scope --assignee $PrincipalId --role $RoleDefinitionId --query \"[?name=='$RoleAssignmentName']\" -o json | ConvertFrom-Json\n        \n        if ($existing -and $existing.Count -gt 0) {\n            Write-Host \"Role assignment $RoleAssignmentName already exists, skipping...\" -ForegroundColor Yellow\n            return\n        }\n        \n        # Build Azure CLI command arguments\n        $azArgs = @(\n            \"role\", \"assignment\", \"create\",\n            \"--scope\", $Scope,\n            \"--role\", $RoleDefinitionId,\n            \"--assignee\", $PrincipalId,\n            \"--assignee-principal-type\", $PrincipalType,\n            \"--name\", $RoleAssignmentName\n        )\n        \n        # Create role assignment\n        az @azArgs | Out-Null\n        \n        if ($LASTEXITCODE -eq 0) {\n            Write-Host \"Successfully assigned role $RoleAssignmentName\" -ForegroundColor Green\n        } else {\n            Write-Warning \"Failed to assign role $RoleAssignmentName (exit code: $LASTEXITCODE)\"\n        }\n    } catch {\n        Write-Warning \"Error assigning role $RoleAssignmentName : $_\"\n    }\n}\n\n# ============================================================================\n# ADMIN RBAC ASSIGNMENTS\n# ============================================================================\n\nWrite-Host \"`n=== Assigning Customer Admin RBAC Roles ===\" -ForegroundColor Cyan\n\n$customerAdminPrincipalType = if ([string]::IsNullOrEmpty($CustomerAdminPrincipalType)) { \"User\" } else { $CustomerAdminPrincipalType }\n\n# Customer Admin: Reader on Resource Group\n$customerAdminReaderName = Get-DeterministicGuid -Scope $ResourceGroupId -PrincipalId $CustomerAdminObjectId -Suffix \"Reader\"\nNew-RoleAssignment -Scope $ResourceGroupId `\n    -RoleDefinitionId $roleDefinitions.Reader `\n    -PrincipalId $CustomerAdminObjectId `\n    -PrincipalType $customerAdminPrincipalType `\n    -RoleAssignmentName $customerAdminReaderName\n\n# Customer Admin: Key Vault Secrets User\nif (![string]::IsNullOrEmpty($KvId)) {\n    $customerAdminKvSecretsUserName = Get-DeterministicGuid -Scope $KvId -PrincipalId $CustomerAdminObjectId -Suffix \"kv-secrets-user\"\n    New-RoleAssignment -Scope $KvId `\n        -RoleDefinitionId $roleDefinitions.KeyVaultSecretsUser `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminKvSecretsUserName\n}\n\n# Customer Admin: Storage Blob Data Reader\nif (![string]::IsNullOrEmpty($StorageId)) {\n    $customerAdminStBlobReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $CustomerAdminObjectId -Suffix \"st-blob-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageBlobDataReader `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminStBlobReaderName\n    \n    # Customer Admin: Storage Queue Data Reader\n    $customerAdminStQueueReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $CustomerAdminObjectId -Suffix \"st-queue-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageQueueDataReader `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminStQueueReaderName\n    \n    # Customer Admin: Storage Table Data Reader\n    $customerAdminStTableReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $CustomerAdminObjectId -Suffix \"st-table-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageTableDataReader `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminStTableReaderName\n}\n\n# Customer Admin: AcrPull\nif (![string]::IsNullOrEmpty($AcrId)) {\n    $customerAdminAcrPullName = Get-DeterministicGuid -Scope $AcrId -PrincipalId $CustomerAdminObjectId -Suffix \"acr-pull\"\n    New-RoleAssignment -Scope $AcrId `\n        -RoleDefinitionId $roleDefinitions.AcrPull `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminAcrPullName\n}\n\n# Customer Admin: Search Service Reader\nif (![string]::IsNullOrEmpty($SearchId)) {\n    $customerAdminSearchReaderName = Get-DeterministicGuid -Scope $SearchId -PrincipalId $CustomerAdminObjectId -Suffix \"search-reader\"\n    New-RoleAssignment -Scope $SearchId `\n        -RoleDefinitionId $roleDefinitions.SearchServiceReader `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminSearchReaderName\n}\n\n# Customer Admin: Cognitive Services User\nif (![string]::IsNullOrEmpty($AiId)) {\n    $customerAdminAiUserName = Get-DeterministicGuid -Scope $AiId -PrincipalId $CustomerAdminObjectId -Suffix \"ai-user\"\n    New-RoleAssignment -Scope $AiId `\n        -RoleDefinitionId $roleDefinitions.CognitiveServicesUser `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminAiUserName\n}\n\n# Customer Admin: Automation Job Operator\nif (![string]::IsNullOrEmpty($AutomationId)) {\n    $customerAdminAutomationJobOpName = Get-DeterministicGuid -Scope $AutomationId -PrincipalId $CustomerAdminObjectId -Suffix \"automation-job-operator\"\n    New-RoleAssignment -Scope $AutomationId `\n        -RoleDefinitionId $roleDefinitions.AutomationJobOperator `\n        -PrincipalId $CustomerAdminObjectId `\n        -PrincipalType $customerAdminPrincipalType `\n        -RoleAssignmentName $customerAdminAutomationJobOpName\n}\n\nWrite-Host \"`nCustomer Admin RBAC role assignment script completed successfully\" -ForegroundColor Green\n",
            "rbacPublisherAdminScript": "# PowerShell script to assign RBAC roles for Publisher Admin (Managed Application Publisher)\n# This script is executed by Azure deploymentScripts resource or automation runbook\n# Parameters are passed via environment variables or script parameters\n# Publisher Admin receives the same roles as Customer Admin\n\nparam(\n    [string]$ResourceGroupId = $env:RESOURCE_GROUP_ID,\n    [string]$PublisherAdminObjectId = $env:PUBLISHER_ADMIN_OBJECT_ID,\n    [string]$PublisherAdminPrincipalType = $env:PUBLISHER_ADMIN_PRINCIPAL_TYPE,\n    [string]$KvId = $env:KV_ID,\n    [string]$StorageId = $env:STORAGE_ID,\n    [string]$AcrId = $env:ACR_ID,\n    [string]$SearchId = $env:SEARCH_ID,\n    [string]$AiId = $env:AI_ID,\n    [string]$AutomationId = $env:AUTOMATION_ID\n)\n\n$ErrorActionPreference = \"Stop\"\n\nWrite-Host \"Starting Publisher Admin RBAC role assignment script...\"\nWrite-Host \"Resource Group ID: $ResourceGroupId\"\nWrite-Host \"Publisher Admin Object ID: $PublisherAdminObjectId\"\n\n# Validate required parameters\nif ([string]::IsNullOrEmpty($ResourceGroupId)) {\n    Write-Error \"RESOURCE_GROUP_ID environment variable is required\"\n    exit 1\n}\n\nif ([string]::IsNullOrEmpty($PublisherAdminObjectId)) {\n    Write-Error \"PUBLISHER_ADMIN_OBJECT_ID environment variable is required\"\n    exit 1\n}\n\n# Role definition IDs (same as Customer Admin)\n$roleDefinitions = @{\n    Reader = \"acdd72a7-3385-48ef-bd42-f606fba81ae7\"\n    KeyVaultSecretsUser = \"4633458b-17de-408a-b874-0445c86b69e6\"\n    StorageBlobDataReader = \"2a2b9908-6ea1-4ae2-8e65-a410df84e7d1\"\n    StorageQueueDataReader = \"19e7f393-937e-4f77-808e-945a386e9b0a\"\n    StorageTableDataReader = \"76199698-9eea-4c19-bc75-cec21354c015\"\n    AcrPull = \"7f951dda-4ed3-4680-a7ca-43fe172d538d\"\n    SearchServiceReader = \"88308d66-4209-4f3e-9b77-8200b49e9c22\"\n    CognitiveServicesUser = \"a97b65f3-24c7-4388-baec-2e87135dc908\"\n    AutomationJobOperator = \"4fe576fe-1146-4730-92eb-48519fa6bf9f\"\n}\n\nfunction Get-DeterministicGuid {\n    param(\n        [string]$Scope,\n        [string]$PrincipalId,\n        [string]$Suffix\n    )\n    \n    # Generate deterministic GUID similar to Bicep guid() function\n    # Bicep's guid() uses a deterministic algorithm based on the input string\n    # We'll use MD5 hash to create a deterministic GUID from the inputs\n    $inputString = \"$Scope-$PrincipalId-$Suffix\"\n    $md5 = [System.Security.Cryptography.MD5]::Create()\n    $hash = $md5.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($inputString))\n    \n    # Create a GUID from the MD5 hash (16 bytes)\n    # GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\n    $guidBytes = New-Object byte[] 16\n    [Array]::Copy($hash, 0, $guidBytes, 0, 16)\n    \n    # Set version bits (version 4 UUID uses bits 12-15 = 0100)\n    $guidBytes[6] = ($guidBytes[6] -band 0x0F) -bor 0x40\n    # Set variant bits (bits 6-7 of byte 8 = 10)\n    $guidBytes[8] = ($guidBytes[8] -band 0x3F) -bor 0x80\n    \n    $guid = New-Object System.Guid(,$guidBytes)\n    return $guid.ToString()\n}\n\nfunction New-RoleAssignment {\n    param(\n        [string]$Scope,\n        [string]$RoleDefinitionId,\n        [string]$PrincipalId,\n        [string]$PrincipalType,\n        [string]$RoleAssignmentName\n    )\n    \n    Write-Host \"Assigning role $RoleAssignmentName at scope $Scope...\"\n    \n    try {\n        # Check if role assignment already exists\n        $existing = az role assignment list --scope $Scope --assignee $PrincipalId --role $RoleDefinitionId --query \"[?name=='$RoleAssignmentName']\" -o json | ConvertFrom-Json\n        \n        if ($existing -and $existing.Count -gt 0) {\n            Write-Host \"Role assignment $RoleAssignmentName already exists, skipping...\" -ForegroundColor Yellow\n            return\n        }\n        \n        # Build Azure CLI command arguments\n        $azArgs = @(\n            \"role\", \"assignment\", \"create\",\n            \"--scope\", $Scope,\n            \"--role\", $RoleDefinitionId,\n            \"--assignee\", $PrincipalId,\n            \"--assignee-principal-type\", $PrincipalType,\n            \"--name\", $RoleAssignmentName\n        )\n        \n        # Create role assignment\n        az @azArgs | Out-Null\n        \n        if ($LASTEXITCODE -eq 0) {\n            Write-Host \"Successfully assigned role $RoleAssignmentName\" -ForegroundColor Green\n        } else {\n            Write-Warning \"Failed to assign role $RoleAssignmentName (exit code: $LASTEXITCODE)\"\n        }\n    } catch {\n        Write-Warning \"Error assigning role $RoleAssignmentName : $_\"\n    }\n}\n\n# ============================================================================\n# PUBLISHER ADMIN RBAC ASSIGNMENTS\n# Same roles as Customer Admin: Reader, Key Vault Secrets User, Storage Readers,\n# ACR Pull, Search Reader, Cognitive Services User, Automation Job Operator\n# ============================================================================\n\nWrite-Host \"`n=== Assigning Publisher Admin RBAC Roles ===\" -ForegroundColor Cyan\n\n$publisherAdminPrincipalType = if ([string]::IsNullOrEmpty($PublisherAdminPrincipalType)) { \"User\" } else { $PublisherAdminPrincipalType }\n\n# Publisher Admin: Reader on Resource Group\n$publisherAdminReaderName = Get-DeterministicGuid -Scope $ResourceGroupId -PrincipalId $PublisherAdminObjectId -Suffix \"Reader\"\nNew-RoleAssignment -Scope $ResourceGroupId `\n    -RoleDefinitionId $roleDefinitions.Reader `\n    -PrincipalId $PublisherAdminObjectId `\n    -PrincipalType $publisherAdminPrincipalType `\n    -RoleAssignmentName $publisherAdminReaderName\n\n# Publisher Admin: Key Vault Secrets User\nif (![string]::IsNullOrEmpty($KvId)) {\n    $publisherAdminKvSecretsUserName = Get-DeterministicGuid -Scope $KvId -PrincipalId $PublisherAdminObjectId -Suffix \"kv-secrets-user\"\n    New-RoleAssignment -Scope $KvId `\n        -RoleDefinitionId $roleDefinitions.KeyVaultSecretsUser `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminKvSecretsUserName\n}\n\n# Publisher Admin: Storage Blob Data Reader\nif (![string]::IsNullOrEmpty($StorageId)) {\n    $publisherAdminStBlobReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $PublisherAdminObjectId -Suffix \"st-blob-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageBlobDataReader `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminStBlobReaderName\n    \n    # Publisher Admin: Storage Queue Data Reader\n    $publisherAdminStQueueReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $PublisherAdminObjectId -Suffix \"st-queue-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageQueueDataReader `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminStQueueReaderName\n    \n    # Publisher Admin: Storage Table Data Reader\n    $publisherAdminStTableReaderName = Get-DeterministicGuid -Scope $StorageId -PrincipalId $PublisherAdminObjectId -Suffix \"st-table-reader\"\n    New-RoleAssignment -Scope $StorageId `\n        -RoleDefinitionId $roleDefinitions.StorageTableDataReader `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminStTableReaderName\n}\n\n# Publisher Admin: AcrPull\nif (![string]::IsNullOrEmpty($AcrId)) {\n    $publisherAdminAcrPullName = Get-DeterministicGuid -Scope $AcrId -PrincipalId $PublisherAdminObjectId -Suffix \"acr-pull\"\n    New-RoleAssignment -Scope $AcrId `\n        -RoleDefinitionId $roleDefinitions.AcrPull `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminAcrPullName\n}\n\n# Publisher Admin: Search Service Reader\nif (![string]::IsNullOrEmpty($SearchId)) {\n    $publisherAdminSearchReaderName = Get-DeterministicGuid -Scope $SearchId -PrincipalId $PublisherAdminObjectId -Suffix \"search-reader\"\n    New-RoleAssignment -Scope $SearchId `\n        -RoleDefinitionId $roleDefinitions.SearchServiceReader `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminSearchReaderName\n}\n\n# Publisher Admin: Cognitive Services User\nif (![string]::IsNullOrEmpty($AiId)) {\n    $publisherAdminAiUserName = Get-DeterministicGuid -Scope $AiId -PrincipalId $PublisherAdminObjectId -Suffix \"ai-user\"\n    New-RoleAssignment -Scope $AiId `\n        -RoleDefinitionId $roleDefinitions.CognitiveServicesUser `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminAiUserName\n}\n\n# Publisher Admin: Automation Job Operator\nif (![string]::IsNullOrEmpty($AutomationId)) {\n    $publisherAdminAutomationJobOpName = Get-DeterministicGuid -Scope $AutomationId -PrincipalId $PublisherAdminObjectId -Suffix \"automation-job-operator\"\n    New-RoleAssignment -Scope $AutomationId `\n        -RoleDefinitionId $roleDefinitions.AutomationJobOperator `\n        -PrincipalId $PublisherAdminObjectId `\n        -PrincipalType $publisherAdminPrincipalType `\n        -RoleAssignmentName $publisherAdminAutomationJobOpName\n}\n\nWrite-Host \"`nPublisher Admin RBAC role assignment script completed successfully\" -ForegroundColor Green\n",
            "uamiForceUpdateTagValue": "[guid(resourceGroup().id, parameters('uamiId'), 'rbac-uami-assignments')]",
            "uamiScriptNameSuffix": "[substring(variables('uamiForceUpdateTagValue'), 0, 8)]",
            "uamiScriptName": "[format('assign-rbac-roles-uami-{0}', variables('uamiScriptNameSuffix'))]",
            "customerAdminForceUpdateTagValue": "[guid(resourceGroup().id, parameters('customerAdminObjectId'), 'rbac-customer-admin-assignments')]",
            "customerAdminScriptNameSuffix": "[substring(variables('customerAdminForceUpdateTagValue'), 0, 8)]",
            "customerAdminScriptName": "[format('assign-rbac-roles-customer-admin-{0}', variables('customerAdminScriptNameSuffix'))]",
            "publisherAdminForceUpdateTagValue": "[guid(resourceGroup().id, parameters('publisherAdminObjectId'), 'rbac-publisher-admin-assignments')]",
            "publisherAdminScriptNameSuffix": "[substring(variables('publisherAdminForceUpdateTagValue'), 0, 8)]",
            "publisherAdminScriptName": "[format('assign-rbac-roles-publisher-admin-{0}', variables('publisherAdminScriptNameSuffix'))]"
          },
          "resources": {
            "automationAccount": {
              "condition": "[and(not(empty(parameters('automationId'))), not(empty(parameters('automationName'))))]",
              "existing": true,
              "type": "Microsoft.Automation/automationAccounts",
              "apiVersion": "2023-11-01",
              "name": "[parameters('automationName')]"
            },
            "assignRbacRolesUami": {
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[variables('uamiScriptName')]",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "forceUpdateTag": "[variables('uamiForceUpdateTagValue')]",
                "retentionInterval": "PT1H",
                "azPowerShellVersion": "11.0",
                "scriptContent": "[variables('rbacUamiScript')]",
                "supportingScriptUris": [],
                "timeout": "PT15M",
                "environmentVariables": [
                  {
                    "name": "RESOURCE_GROUP_ID",
                    "value": "[resourceGroup().id]"
                  },
                  {
                    "name": "UAMI_PRINCIPAL_ID",
                    "value": "[parameters('uamiPrincipalId')]"
                  },
                  {
                    "name": "UAMI_ID",
                    "value": "[parameters('uamiId')]"
                  },
                  {
                    "name": "LAW_ID",
                    "value": "[parameters('lawId')]"
                  },
                  {
                    "name": "LAW_NAME",
                    "value": "[parameters('lawName')]"
                  },
                  {
                    "name": "KV_ID",
                    "value": "[parameters('kvId')]"
                  },
                  {
                    "name": "STORAGE_ID",
                    "value": "[parameters('storageId')]"
                  },
                  {
                    "name": "ACR_ID",
                    "value": "[parameters('acrId')]"
                  },
                  {
                    "name": "SEARCH_ID",
                    "value": "[parameters('searchId')]"
                  },
                  {
                    "name": "AI_ID",
                    "value": "[parameters('aiId')]"
                  },
                  {
                    "name": "AUTOMATION_ID",
                    "value": "[parameters('automationId')]"
                  },
                  {
                    "name": "IS_MANAGED_APPLICATION",
                    "value": "[string(parameters('isManagedApplication'))]"
                  }
                ]
              }
            },
            "assignRbacRolesCustomerAdmin": {
              "condition": "[not(empty(parameters('customerAdminObjectId')))]",
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[variables('customerAdminScriptName')]",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "forceUpdateTag": "[variables('customerAdminForceUpdateTagValue')]",
                "retentionInterval": "PT1H",
                "azPowerShellVersion": "11.0",
                "scriptContent": "[variables('rbacCustomerAdminScript')]",
                "supportingScriptUris": [],
                "timeout": "PT15M",
                "environmentVariables": [
                  {
                    "name": "RESOURCE_GROUP_ID",
                    "value": "[resourceGroup().id]"
                  },
                  {
                    "name": "CUSTOMER_ADMIN_OBJECT_ID",
                    "value": "[parameters('customerAdminObjectId')]"
                  },
                  {
                    "name": "CUSTOMER_ADMIN_PRINCIPAL_TYPE",
                    "value": "[parameters('customerAdminPrincipalType')]"
                  },
                  {
                    "name": "KV_ID",
                    "value": "[parameters('kvId')]"
                  },
                  {
                    "name": "STORAGE_ID",
                    "value": "[parameters('storageId')]"
                  },
                  {
                    "name": "ACR_ID",
                    "value": "[parameters('acrId')]"
                  },
                  {
                    "name": "SEARCH_ID",
                    "value": "[parameters('searchId')]"
                  },
                  {
                    "name": "AI_ID",
                    "value": "[parameters('aiId')]"
                  },
                  {
                    "name": "AUTOMATION_ID",
                    "value": "[parameters('automationId')]"
                  }
                ]
              }
            },
            "assignRbacRolesPublisherAdmin": {
              "condition": "[and(parameters('isManagedApplication'), not(empty(parameters('publisherAdminObjectId'))))]",
              "type": "Microsoft.Resources/deploymentScripts",
              "apiVersion": "2020-10-01",
              "name": "[variables('publisherAdminScriptName')]",
              "location": "[parameters('location')]",
              "kind": "AzurePowerShell",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('uamiId'))]": {}
                }
              },
              "properties": {
                "forceUpdateTag": "[variables('publisherAdminForceUpdateTagValue')]",
                "retentionInterval": "PT1H",
                "azPowerShellVersion": "11.0",
                "scriptContent": "[variables('rbacPublisherAdminScript')]",
                "supportingScriptUris": [],
                "timeout": "PT15M",
                "environmentVariables": [
                  {
                    "name": "RESOURCE_GROUP_ID",
                    "value": "[resourceGroup().id]"
                  },
                  {
                    "name": "PUBLISHER_ADMIN_OBJECT_ID",
                    "value": "[parameters('publisherAdminObjectId')]"
                  },
                  {
                    "name": "PUBLISHER_ADMIN_PRINCIPAL_TYPE",
                    "value": "[parameters('publisherAdminPrincipalType')]"
                  },
                  {
                    "name": "KV_ID",
                    "value": "[parameters('kvId')]"
                  },
                  {
                    "name": "STORAGE_ID",
                    "value": "[parameters('storageId')]"
                  },
                  {
                    "name": "ACR_ID",
                    "value": "[parameters('acrId')]"
                  },
                  {
                    "name": "SEARCH_ID",
                    "value": "[parameters('searchId')]"
                  },
                  {
                    "name": "AI_ID",
                    "value": "[parameters('aiId')]"
                  },
                  {
                    "name": "AUTOMATION_ID",
                    "value": "[parameters('automationId')]"
                  }
                ]
              }
            },
            "rbacUamiRunbook": {
              "condition": "[and(not(empty(parameters('automationId'))), not(empty(parameters('automationName'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', parameters('automationName'), 'assign-rbac-roles-uami')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "runbookType": "PowerShell",
                "logVerbose": false,
                "logProgress": true,
                "description": "Assigns all RBAC roles for UAMI. Can be run by admins to re-apply UAMI RBAC assignments. Parameters: ResourceGroupId, UamiPrincipalId, UamiId, LawId, LawName, KvId, StorageId, AcrId, SearchId, AiId, AutomationId, IsManagedApplication."
              },
              "dependsOn": [
                "automationAccount"
              ]
            },
            "rbacUamiRunbookDraft": {
              "condition": "[and(not(empty(parameters('automationId'))), not(empty(parameters('automationName'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('automationName'), 'assign-rbac-roles-uami', 'content')]",
              "dependsOn": [
                "rbacUamiRunbook"
              ]
            },
            "rbacUamiRunbookContent": {
              "condition": "[and(not(empty(parameters('automationId'))), not(empty(parameters('automationName'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft/content",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('automationName'), 'assign-rbac-roles-uami', 'content', 'content')]",
              "properties": {
                "content": "[variables('rbacUamiScript')]"
              },
              "dependsOn": [
                "rbacUamiRunbookDraft"
              ]
            },
            "rbacCustomerAdminRunbook": {
              "condition": "[and(and(not(empty(parameters('automationId'))), not(empty(parameters('automationName')))), not(empty(parameters('customerAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', parameters('automationName'), 'assign-rbac-roles-admin')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "runbookType": "PowerShell",
                "logVerbose": false,
                "logProgress": true,
                "description": "Assigns all RBAC roles for Customer Admin. Can be run by admins to re-apply Customer Admin RBAC assignments. Parameters: ResourceGroupId, CustomerAdminObjectId, CustomerAdminPrincipalType (User or Group, defaults to User), KvId, StorageId, AcrId, SearchId, AiId, AutomationId."
              },
              "dependsOn": [
                "automationAccount"
              ]
            },
            "rbacCustomerAdminRunbookDraft": {
              "condition": "[and(and(not(empty(parameters('automationId'))), not(empty(parameters('automationName')))), not(empty(parameters('customerAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('automationName'), 'assign-rbac-roles-admin', 'content')]",
              "dependsOn": [
                "rbacCustomerAdminRunbook"
              ]
            },
            "rbacCustomerAdminRunbookContent": {
              "condition": "[and(and(not(empty(parameters('automationId'))), not(empty(parameters('automationName')))), not(empty(parameters('customerAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft/content",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('automationName'), 'assign-rbac-roles-admin', 'content', 'content')]",
              "properties": {
                "content": "[variables('rbacCustomerAdminScript')]"
              },
              "dependsOn": [
                "rbacCustomerAdminRunbookDraft"
              ]
            },
            "rbacPublisherAdminRunbook": {
              "condition": "[and(and(and(parameters('isManagedApplication'), not(empty(parameters('automationId')))), not(empty(parameters('automationName')))), not(empty(parameters('publisherAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks",
              "apiVersion": "2023-11-01",
              "name": "[format('{0}/{1}', parameters('automationName'), 'assign-rbac-roles-publisher-admin')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "runbookType": "PowerShell",
                "logVerbose": false,
                "logProgress": true,
                "description": "Assigns all RBAC roles for Publisher Admin (same as Customer Admin). Can be run by admins to re-apply Publisher Admin RBAC assignments. Parameters: ResourceGroupId, PublisherAdminObjectId, PublisherAdminPrincipalType, KvId, StorageId, AcrId, SearchId, AiId, AutomationId."
              },
              "dependsOn": [
                "automationAccount"
              ]
            },
            "rbacPublisherAdminRunbookDraft": {
              "condition": "[and(and(and(parameters('isManagedApplication'), not(empty(parameters('automationId')))), not(empty(parameters('automationName')))), not(empty(parameters('publisherAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('automationName'), 'assign-rbac-roles-publisher-admin', 'content')]",
              "dependsOn": [
                "rbacPublisherAdminRunbook"
              ]
            },
            "rbacPublisherAdminRunbookContent": {
              "condition": "[and(and(and(parameters('isManagedApplication'), not(empty(parameters('automationId')))), not(empty(parameters('automationName')))), not(empty(parameters('publisherAdminObjectId'))))]",
              "type": "Microsoft.Automation/automationAccounts/runbooks/draft/content",
              "apiVersion": "2019-06-01",
              "name": "[format('{0}/{1}/{2}/{3}', parameters('automationName'), 'assign-rbac-roles-publisher-admin', 'content', 'content')]",
              "properties": {
                "content": "[variables('rbacPublisherAdminScript')]"
              },
              "dependsOn": [
                "rbacPublisherAdminRunbookDraft"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "naming"
      ]
    }
  },
  "outputs": {
    "names": {
      "type": "object",
      "value": "[reference('naming').outputs.names.value]"
    }
  }
}